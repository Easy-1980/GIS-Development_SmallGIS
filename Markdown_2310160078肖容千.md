# ä¸€ã€GISå¼€å‘æœŸæœ«å¤§ä½œä¸š Â· BUGä¿®å¤

ï¼ˆåŸºäºC#çš„ArcEngineæ¡Œé¢å¼€å‘ï¼‰

> **Created By:** è‚–å®¹åƒ
> **Date:** 2026.1.1
---

## Bugä¿®å¤

### 1.  è§£å†³äº†å› æœªå¯¼å…¥æ•°æ®åœ¨`axMapControl2`ä¸Šè¿›è¡Œé¼ æ ‡ç§»åŠ¨å¯¼è‡´çš„ç©ºå¼•ç”¨æŠ¥é”™çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šåŠ å…¥ä¸€ä¸ª`ifåˆ¤æ–­`é˜²æ­¢ç©ºå¼•ç”¨æŠ¥é”™ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
if (pEnv == null || pEnv.IsEmpty)
{
    axMapControl2.MousePointer = esriControlsMousePointer.esriPointerDefault;
    return;
}
```

---

### 2.  è§£å†³äº†åŠ è½½`æ …æ ¼æ•°æ®`ã€`SHPæ•°æ®`ã€`ä¸ªäººåœ°ç†æ•°æ®åº“æ•°æ®`æ— æ³•å°†å…¶åŒæ­¥åœ¨é¹°çœ¼æ§ä»¶çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šåœ¨æ•°æ®åŠ è½½å®Œæˆåç«‹å³è°ƒç”¨é¹°çœ¼åŒæ­¥æ–¹æ³•ï¼Œç¡®ä¿æ¦‚è§ˆå›¾åˆ·æ–°;æ›´æ–° `Synchronize_axMapControl2`ï¼Œæ˜¾å¼æ”¯æŒ `IRasterLayer` å¹¶å¯¹è¦ç´ å›¾å±‚åšç©ºå€¼ä¸ç±»å‹åˆ¤æ–­ï¼Œé¿å…å› æ …æ ¼æˆ–ç©ºè¦ç´ ç±»å¯¼è‡´æ¦‚è§ˆå›¾ä¸åŒæ­¥æˆ–ç©ºå¼•ç”¨ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
// åŒæ­¥é¹°çœ¼æ§ä»¶æ˜¾ç¤ºæ …æ ¼å›¾å±‚
Synchronize_axMapControl2();

if (pSubLayer is IRasterLayer)
{
    axMapControl2.AddLayer(pSubLayer);
    continue;
}

```

---

### 3.  è§£å†³äº†åŠ è½½`TXTæ–‡æœ¬æ•°æ®`æ— æ³•å°†å…¶åŒæ­¥åœ¨é¹°çœ¼æ§ä»¶çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šåœ¨ TXT æ•°æ®ç”Ÿæˆå¹¶åŠ è½½åˆ°ä¸»åœ°å›¾æ—¶è§¦å‘ä¸€ä¸ªâ€œå›¾å±‚å·²åˆ›å»ºâ€äº‹ä»¶ï¼›ä¸»çª—ä½“åœ¨æ‰“å¼€ TXT å¯¹è¯æ¡†æ—¶è®¢é˜…è¯¥äº‹ä»¶ï¼Œå¹¶åœ¨äº‹ä»¶è§¦å‘æ—¶è°ƒç”¨ç°æœ‰çš„ `Synchronize_axMapControl2()`ï¼Œä»¥å®Œæˆé¹°çœ¼èŒƒå›´ä¸å›¾å±‚çš„åŒæ­¥ã€‚è®¢é˜…å¤„ç†ä¸ºä¸€æ¬¡æ€§å›è°ƒï¼Œé¿å…é‡å¤ç»‘å®šã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
private void åŠ è½½TXTæ–‡æœ¬æ•°æ®ToolStripMenuItem_Click(object sender, EventArgs e)
{
    FormAddTxt fat = new FormAddTxt();
    fat.BuddyMap = axMapControl1;

    EventHandler syncHandler = null;
    syncHandler = (s, args) =>
    {
        Synchronize_axMapControl2();
        fat.LayerCreated -= syncHandler;
    };
    fat.LayerCreated += syncHandler;

    fat.Show();
}
// åœ¨FormAddTxt.csä¸­æ–°å¢äº‹ä»¶å£°æ˜
public event EventHandler LayerCreated;
// åœ¨buuton3_clickï¼ˆåˆ›å»ºæŒ‰é’®ï¼‰äº‹ä»¶ä¸­è®¢é˜…LayerCreatedäº‹ä»¶
EventHandler handler = LayerCreated;
if (handler != null)
{
    handler(this, EventArgs.Empty);
}

```
-   1ï¼‰å› ä¸ºåœ¨é¹°çœ¼æ§ä»¶ä¸ŠåŸæœ¬åªå…è®¸æ˜¾ç¤ºçº¿é¢å›¾å±‚ï¼Œæ˜ç¡®æ’é™¤äº†ç‚¹å’Œå¤šç‚¹å› æ­¤è¿˜éœ€æ›´æ”¹ifåˆ¤æ–­å…è®¸ç‚¹å›¾å±‚ä¹ŸåŠ å…¥ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
if (pFeatureLayer != null && pFeatureLayer.FeatureClass != null)
{
    
}

```

---

### 4.  è§£å†³äº†åœ¨å¯¹`axMapControl1`ä¸­çš„æ•°æ®è¿›è¡Œç¼–è¾‘å(å¦‚ç§»é™¤å›¾å±‚ã€ç¼–è¾‘è¦ç´ )é¹°çœ¼æ§ä»¶ä¸Šæ— æ³•åŒæ­¥çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šåœ¨ç§»é™¤å›¾å±‚æ“ä½œå®Œæˆåä¸»åŠ¨è°ƒç”¨é¹°çœ¼åŒæ­¥æ–¹æ³•ï¼Œç¡®ä¿æ¦‚è§ˆå›¾å³æ—¶æ›´æ–°ã€‚åœ¨ä¿å­˜ç¼–è¾‘å’Œç»“æŸç¼–è¾‘æ“ä½œåï¼ŒåŒæ­¥è°ƒç”¨é¹°çœ¼åˆ·æ–°é€»è¾‘ï¼Œä½¿ç¼–è¾‘ç»“æœç›´æ¥åæ˜ åˆ°`axMapControl2`ã€‚å³åœ¨å„ä¸ªæ“ä½œååŠ åŒæ­¥ä»£ç ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
// ç§»é™¤å›¾å±‚ååŒæ­¥é¹°çœ¼æ§ä»¶
Synchronize_axMapControl2();
```

---

### 5.  è§£å†³äº†åŠ è½½æ–‡ä»¶åœ°ç†æ•°æ®åº“æ•°æ®æ—¶ï¼Œ`axTOCControl1`ä¼šæ˜¾ç¤ºå›¾å±‚ä¿¡æ¯ï¼Œä½†æ˜¯`axMapControl`1å’Œ`axMapControl2`é‡Œä¸æ˜¾ç¤ºåœ°å›¾ï¼ŒåŒæ—¶æ•´ä¸ªçª—ä½“ä¼šå¡æ­»ï¼Œåªå¯ä»¥é€šè¿‡åœ¨VSé‡Œç»“æŸç¼–è¯‘åœæ­¢è¿è¡Œçš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šä¿®æ­£è¦ç´ æ•°æ®é›†å­é›†éå†çš„å¾ªç¯æ¡ä»¶ï¼Œä½¿ç”¨å­é›†æšä¸¾å˜é‡æ§åˆ¶å¾ªç¯ç»ˆæ­¢ï¼Œé¿å…æ­»å¾ªç¯ï¼Œç¡®ä¿å›¾å±‚æ­£å¸¸æ·»åŠ å¹¶åˆ·æ–°åˆ°ä¸»å›¾å’Œé¹°çœ¼ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
while (pDataset1 != null)
{

}
```
>   `å…¶å®æˆ‘è§‰å¾—è¿™é‡Œåº”è¯¥æ˜¯æˆ‘å½“æ—¶ä»£ç æ•²é”™äº†ğŸ¤¡....`

---

### 6.  è§£å†³äº†å¤šæ¬¡åŠ è½½ä¸åŒæ•°æ®ç±»å‹çš„æ–‡ä»¶æ—¶ä¸ä¼šå°†åŸæ¥æ˜¾ç¤ºåœ¨`axMapControl`1å’Œ`axMapControl2`çš„åœ°å›¾è¦†ç›–çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šä¿®æ”¹`ClearAllDataï¼ˆï¼‰`ï¼Œåœ¨`shapefile`å·¥ä½œç©ºé—´åŠ è½½ã€`AddShapeFile`åŠ è½½ã€æ …æ ¼åŠ è½½å‰è°ƒç”¨`ClearAllData()`ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#

private void ClearAllData()
{
    ...
        // +
        axMapControl1.ActiveView.Refresh();
    }

    if (axMapControl2 != null)
    {
        axMapControl2.ClearLayers();
        IMap overviewMap = new MapClass();
        overviewMap.Name = "Overview";
        axMapControl2.Map = overviewMap;
        axMapControl2.ActiveView.Refresh();
    }
}

// +
ClearAllData();
```

**6.1ä½†æ˜¯è¿™æ ·æ”¹ä¼šå¯¼è‡´åŸæ•°æ®ç›´æ¥è¢«æ¸…é™¤ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜**

**1ï¼‰ä¸»è¦æ€è·¯**ï¼š
*   æ–°å¢`ZoomToLayerï¼ˆILayer layerï¼‰`æ–¹æ³•:åœ¨æ·»åŠ æ–°å›¾å±‚åè‡ªåŠ¨ç¼©æ”¾è‡³è¯¥å›¾å±‚ï¼ŒåŒæ—¶è°ƒç”¨ `Synchronize_axMapControl2`ï¼Œä½¿æ–°å›¾å±‚è¦†ç›–æ˜¾ç¤ºä½†æ—§å›¾å±‚ä»å¯åœ¨`axTOCControl1`é‡Œåˆ‡æ¢å¯è§æ€§ï¼›
*   ä¿®æ”¹`åŠ è½½MXDæ•°æ®`å’Œ`FormAddTxt`çš„ä»£ç é€»è¾‘ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
        private void ZoomToLayer(ILayer layer)
        {
            if (layer == null)
            {
                return;
            }
            IEnvelope extent = layer.AreaOfInterest;
            if (extent != null && !extent.IsEmpty)
            {
                axMapControl1.Extent = extent;
                axMapControl1.ActiveView.Refresh();
                Synchronize_axMapControl2();
            }
        }
        // MXD
        if (axMapControl1.CheckMxFile(pFileName))
                {
                    ..
                    //// è·å–Mapä¸­æ¿€æ´»çš„åœ°å›¾
                    //axMapControl1.Map = pMapDocument.ActiveView.FocusMap;

                    // repair
                    IMap sourceMap = pMapDocument.ActiveView.FocusMap;
                    IMap targetMap = axMapControl1.Map;

                    for (int i = 0; i < sourceMap.LayerCount; i++)
                    {
                        ILayer layerToAdd = sourceMap.get_Layer(i);
                        targetMap.AddLayer(layerToAdd);
                    }
                    ...
                }
        // FormAddTxt
        else
        {
            ...
            // repair
            //IMap pMap = new MapClass();
            //pMap.Name = "Map";
            //buddyMap.DocumentFilename = string.Empty;
            //buddyMap.Map = pMap;
            if (buddyMap.Map == null)
            {
                IMap newMap = new MapClass();
                newMap.Name = "Map";
                buddyMap.Map = newMap;
            }
        }
```

---

### 7.  è§£å†³äº†åŠ è½½å¤šä¸ªæ•°æ®æºæ—¶æ–°åŠ è½½çš„åœ°å›¾æ— æ³•æˆä¸º`ç„¦ç‚¹å›¾å±‚`çš„é—®é¢˜ã€‚å¦‚ï¼šåŠ è½½`æ …æ ¼å›¾å±‚`å†åŠ è½½`MXDæ•°æ®`ï¼Œ`axMapControl1`å’Œ`axMapControl2`ä¸­ä»æ˜¾ç¤º`æ …æ ¼å›¾å±‚ä¿¡æ¯`

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šåœ¨æ‰€æœ‰ MXD åŠ è½½å…¥å£ä¸­ï¼Œå°† MXD å›¾å±‚è¿½åŠ åˆ°ç°æœ‰ Map åï¼Œç«‹å³åŒæ­¥é¹°çœ¼å¹¶ç¼©æ”¾åˆ°æœ€æ–°æ·»åŠ çš„å›¾å±‚ï¼Œä½¿æœ€æ–°æ•°æ®æˆä¸ºå½“å‰è§†å›¾ç„¦ç‚¹ã€‚è‹¥å½“å‰ Map ä¸ºç©ºï¼Œå…ˆåˆ›å»ºæ–°çš„ Mapï¼Œç¡®ä¿è¿½åŠ ä¸åˆ·æ–°é€»è¾‘å¯æ‰§è¡Œã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
 // repair
//axMapControl1.ActiveView.Refresh();
Synchronize_axMapControl2();
ZoomToLayer(lastLayerAdded);
```
>   å¾ˆé—æ†¾ï¼Œåˆ«çš„åŠ è½½ä»£ç è¿™æ ·çš„æ€è·¯ä¸è¡Œï¼Œæˆ‘ä¸çŸ¥é“é—®é¢˜å‡ºåœ¨å“ªé‡ŒğŸ˜­

---

### 8.  è§£å†³äº†åœ¨`axOCControl1`ä¸Šè®¾ç½®å›¾å±‚ä¸å¯è§æ—¶ï¼Œé¹°çœ¼æ— æ³•åŒæ­¥æ›´æ–°ä¸å¯è§çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼š
*   åœ¨`axTOCControl1_OnMouseUp`ä¸­ç›´æ¥åˆ·æ–°ä¸»å›¾å¹¶è°ƒç”¨`Synchronize_axMapControl2()`ï¼Œä¿è¯æ¯æ¬¡å¯è§æ€§åˆ‡æ¢éƒ½ä¼šé©±åŠ¨é¹°çœ¼æ›´æ–°,æœ€åä¸€è¡Œç›´æ¥è°ƒç”¨`Synchronize_axMapControl2()`ï¼Œç¡®ä¿æ— è®ºå‹¾é€‰å¯è§æ€§è¿˜æ˜¯æ‹–æ‹½æ’åºï¼Œé¹°çœ¼éƒ½ä¼šåŒæ­¥åˆ·æ–°;
*   åœ¨`Synchronize_axMapControl2()` ä¸­è·³è¿‡ä¸å¯è§å›¾å±‚ï¼ˆå«ç»„å†…å­å›¾å±‚ï¼‰ï¼Œåªå‘é¹°çœ¼æ·»åŠ å½“å‰å¯è§çš„æ•°æ®ï¼Œä¿æŒè§†å›¾ä¸€è‡´ã€‚

**1ï¼‰æ ¸å¿ƒä»£ç **ï¼š
```C#
// Mouseup
private void axTOCControl1_OnMouseUp(object sender, ITOCControlEvents_OnMouseUpEvent e)
{
    ...
    if (pMoveLayer == null || focusMap == null || focusMap.LayerCount == 0)
    {
        // å¤„ç†ä»…å‹¾é€‰/å–æ¶ˆå¯è§æ€§æ—¶çš„åŒæ­¥
        if (pLayer != null && pItem == esriTOCControlItem.esriTOCControlItemLayer)
        {
            axMapControl1.ActiveView.Refresh();
            Synchronize_axMapControl2();
        }
    return; // é¿å… MoveLayer æŠ›â€œå€¼ä¸åœ¨é¢„æœŸèŒƒå›´å†…â€
    }
   ...
    // å›¾å±‚å¯è§æ€§æˆ–é¡ºåºå˜åŒ–ååŒæ­¥é¹°çœ¼
    Synchronize_axMapControl2();
}
// Synchronize
...
for (int i = axMapControl1.LayerCount-1; i >= 0; i--)
    {
        ILayer pLayer = axMapControl1.get_Layer(i);
        if (pLayer == null || !pLayer.Visible)
        {
            continue;
        }
        if (pLayer is IGroupLayer||pLayer is ICompositeLayer)
        {
            ICompositeLayer pCompositeLayer = pLayer as ICompositeLayer;
            for (int j = pCompositeLayer.Count-1; j >= 0; j--)
            {
                ILayer pSubLayer = pCompositeLayer.get_Layer(j);

                if (pSubLayer == null || !pSubLayer.Visible)
                {
                    continue;
                }

                // æ”¯æŒæ …æ ¼å›¾å±‚åŠè¿‡æ»¤ç‚¹å›¾å±‚
                if (pSubLayer is IRasterLayer)
                {
                    axMapControl2.AddLayer(pSubLayer);
                    continue;
                }
                ...
            }
            ...
        }
        ...
    }
...
```

---

### 9. è§£å†³äº†åœ¨axTOCControl1å³é”®æ‰“å¼€èœå•æ ç§»é™¤å›¾å±‚æ—¶ï¼Œ`focusMap.MoveLayer(pMoveLayer, toIndex);`æŠ¥é”™ï¼šå€¼ä¸åœ¨é¢„æœŸçš„èŒƒå›´å†…

**1ï¼‰ä¸»è¦æ€è·¯**ï¼š
*   åœ¨`MouseUp`ä¸­å¯¹é`Layer/None/Map`çš„èŠ‚ç‚¹ç›´æ¥è¿”å›å¹¶æ¸…ç©º`pMoveLayer`ï¼›
*   åœ¨ç§»åŠ¨å‰æ ¡éªŒ`toIndex`åˆæ³•æ€§ï¼Œé¿å…æ— æ•ˆç´¢å¼•è°ƒç”¨`MoveLayer`ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
if (pMoveLayer == null || focusMap == null || focusMap.LayerCount == 0)
{
    ...
    return; // é¿å… MoveLayer æŠ›â€œå€¼ä¸åœ¨é¢„æœŸèŒƒå›´å†…â€
}
// éå›¾å±‚èŠ‚ç‚¹ï¼ˆä¾‹å¦‚ Headingï¼‰ç›´æ¥è·³è¿‡ï¼Œé¿å… MoveLayer æŠ›å¼‚å¸¸
if (pItem != esriTOCControlItem.esriTOCControlItemLayer &&
pItem != esriTOCControlItem.esriTOCControlItemNone &&
Item != esriTOCControlItem.esriTOCControlItemMap)
{
    pMoveLayer = null;
    return;
}
if (pItem == esriTOCControlItem.esriTOCControlItemLayer || pLayer != null)
...

...
// é˜²å¾¡ï¼šç´¢å¼•æ— æ•ˆåˆ™ä¸æ‰§è¡Œç§»åŠ¨
if (pMoveLayer == null || toIndex < 0 || toIndex >= focusMap.LayerCount)
{
    pMoveLayer = null;
    return;
}
focusMap.MoveLayer(pMoveLayer, toIndex);
...
```

---

### 10. è§£å†³äº†ç»˜åˆ¶çŸ©å½¢æ¡†æ—¶æ¡†é€‰ç©ºå‡ ä½•è¦ç´ æ—¶å¯¼è‡´çš„æŠ¥é”™`The operation was attempted on an empty geometry.`

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šåœ¨é¹°çœ¼å³é”®ç»˜åˆ¶çŸ©å½¢æ—¶åŠ ç©ºçŸ©å½¢é˜²æŠ¤ï¼Œé¿å…ç©ºå‡ ä½•å¯¼è‡´å´©æºƒã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
...
// æŒ‰ä¸‹é¼ æ ‡å³é”®ç»˜åˆ¶çŸ©å½¢æ¡†
if (e.button == 2)
{
    IEnvelope pEnvelope = axMapControl2.TrackRectangle();
    if (pEnvelope == null || pEnvelope.IsEmpty)
    {
        return; // ç©ºçŸ©å½¢ä¸å¤„ç†ï¼Œé¿å…ç©ºå‡ ä½•æŠ¥é”™
    }
    IPoint pTempoint = new PointClass();  
    pTempoint.PutCoords(pEnvelope.XMin + pEnvelope.Width / 2, pEnvelope.YMin + pEnvelope.Height / 2);
    axMapControl1.Extent = pEnvelope;
    // çŸ©å½¢æ¡†çš„é«˜å®½å’Œæ•°æ®è§†å›¾çš„é«˜å®½ä¸ä¸€å®šæˆæ­£æ¯”ï¼Œè¿™é‡Œåšä¸€ä¸ªä¸­å¿ƒè°ƒæ•´
    axMapControl1.CenterAt(pTempoint);
}
...
```

---

### 11. è§£å†³äº†åŒå‡»æ …æ ¼å›¾å±‚æˆ–å…¶ä»–éè¦ç´ å›¾å±‚æ—¶ï¼Œ`IGeoFeatureLayer pGeoFeatureLayer = (IGeoFeatureLayer)pLayer;`æŠ¥é”™å¼ºåˆ¶è½¬æ¢å¼‚å¸¸çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šåœ¨`frmSymbolSelector_Load`ä¸­ï¼Œå…ˆç”¨`as å®‰å…¨è½¬æ¢`æ£€æŸ¥å›¾å±‚æ˜¯å¦ä¸º`IFeatureLayer`å’Œ `IGeoFeatureLayer`ï¼Œè‹¥è½¬æ¢å¤±è´¥åˆ™ç›´æ¥å…³é—­çª—ä½“ï¼Œé¿å…å¼ºåˆ¶è½¬æ¢æŠ›å¼‚å¸¸ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
private void frmSymbolSelector_Load(object sender, EventArgs e)
{
    string path = filepath + "ESRI.ServerStyle";
    this.SymbologyCtr.LoadStyleFile(path);
    // ç¡®å®šå›¾å±‚çš„ç±»å‹(ç‚¹çº¿é¢),è®¾ç½®å¥½SymbologyControlçš„StyleClass,è®¾ç½®å¥½å„æ§ä»¶çš„å¯è§æ€§(visible)
    // æ£€æŸ¥å›¾å±‚æ˜¯å¦ä¸ºè¦ç´ å›¾å±‚ï¼Œè‹¥ä¸æ˜¯åˆ™å…³é—­çª—ä½“
    IFeatureLayer pFeatureLayer = pLayer as IFeatureLayer;
    if (pFeatureLayer == null || pFeatureLayer.FeatureClass == null)
    {
        this.Close();
        return;
    }
            
    IGeoFeatureLayer pGeoFeatureLayer = pLayer as IGeoFeatureLayer;
    if (pGeoFeatureLayer == null)
    {
        this.Close();
        return;
    }
            
    switch (pFeatureLayer.FeatureClass.ShapeType)
    ...
}
```

---

### 12. è§£å†³äº†ç‚¹å‡»`axTOCControl1`é‡Œçš„`å›¾å±‚æ•°æ®`ä¼šå°†å…¶ç›´æ¥ç½®é¡¶çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼š
*   ä¸ºå›¾å±‚æ‹–æ‹½æ“ä½œå¼•å…¥æ˜ç¡®çš„åˆå§‹æ— æ•ˆç´¢å¼•`toIndex=-1`ï¼Œå¹¶åœ¨æŒ‰ä¸‹/æŠ¬èµ·æ—¶é‡ç½®çŠ¶æ€ï¼Œåªæœ‰è®¡ç®—å‡ºæœ‰æ•ˆç›®æ ‡ç´¢å¼•æ—¶æ‰è°ƒç”¨ `MoveLayer`;
*   å¯¹ä»…å•å‡»ï¼ˆæœªäº§ç”Ÿæœ‰æ•ˆç›®æ ‡ç´¢å¼•ï¼‰æˆ–ä»…å‹¾é€‰å¯è§æ€§çš„æƒ…å½¢ï¼Œè·³è¿‡`MoveLayer`ï¼Œåªåšå¿…è¦çš„åˆ·æ–°ä¸åŒæ­¥;åœ¨äº‹ä»¶ç»“æŸåæ¸…ç†ä¸´æ—¶çŠ¶æ€ï¼Œé¿å…åç»­æ“ä½œå¤ç”¨ä¸Šä¸€æ¬¡çš„æ‹–æ‹½ä¿¡æ¯ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
// 1.è®¾å®šå…¨å±€å˜é‡
private int toIndex = -1;

// 2.Mousedownå¼€å§‹ä½ç½®è®¾ç½®
pMoveLayer = null;
toIndex = -1;

// 3.Mouseupå¼€å§‹ä½ç½®è®¾ç½®
toIndex = -1;

// å¤„ç†ä»…å‹¾é€‰/å–æ¶ˆå¯è§æ€§æ—¶çš„åŒæ­¥
if (pLayer != null && pItem == esriTOCControlItem.esriTOCControlItemLayer)
{
    axMapControl1.ActiveView.Refresh();
    Synchronize_axMapControl2();
}
    // 4.repairï¼šå†æ¬¡è®¾ç½®ä¸ºnull
    pMoveLayer = null;
    return; // é¿å… MoveLayer æŠ›â€œå€¼ä¸åœ¨é¢„æœŸèŒƒå›´å†…â€

// é˜²å¾¡ï¼šç´¢å¼•æ— æ•ˆåˆ™ä¸æ‰§è¡Œç§»åŠ¨
if (pMoveLayer == null || toIndex < 0 || toIndex >= focusMap.LayerCount)
{
    if (pLayer != null && pItem == esriTOCControlItem.esriTOCControlItemLayer)
    {
        axMapControl1.ActiveView.Refresh();
        Synchronize_axMapControl2();
    }
    // 5.é‡ç½®
    pMoveLayer = null;
    toIndex = -1;
    return;
}

// 6.å›¾å±‚å¯è§æ€§æˆ–é¡ºåºå˜åŒ–ååŒæ­¥é¹°çœ¼
Synchronize_axMapControl2();
// 7.æ¸…ç†ä¸´æ—¶çŠ¶æ€
pMoveLayer = null;
toIndex = -1;
```

---

### 13. è§£å†³äº†åˆ‡æ¢åˆ°å¸ƒå±€è§†å›¾åœ°å›¾é—ªçƒçš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼š
*   ä¸º`PageLayout`åŒæ­¥æ·»åŠ é‡å…¥ä¿æŠ¤ä¸èŒƒå›´ç¼“å­˜ï¼šä½¿ç”¨å…¨å±€å˜é‡`isPageLayoutSyncing`è§„é¿äº‹ä»¶é‡å…¥ï¼›å…‹éš†å½“å‰`Extent`ï¼Œè‹¥ä¸`lastPageLayoutEnv`ç›¸åŒåˆ™è·³è¿‡åŒæ­¥ï¼Œå‡å°‘æ— æ•ˆé‡ç»˜;
*   å‡å°‘åˆ·æ–°æ¬¡æ•°ï¼š`CopyToPageLayout`åŠ`PageLayout`åŒæ­¥ä¸­ä½¿ç”¨ `PartialRefresh`æ›¿ä»£å…¨é‡`Refresh`ï¼Œå‡å°‘é—ªçƒ;
*   ä¿æŒæ‹–æ‹½å±‚æ¬¡é€»è¾‘ç¨³å®šï¼šåœ¨`TOCControl`äº‹ä»¶ä¸­æ¸…ç†æ‹–æ‹½çŠ¶æ€å¹¶é˜²å¾¡æ— æ•ˆç´¢å¼•ï¼Œé¿å…å•å‡»è¯¯è§¦å‘`MoveLayer`ï¼ˆä¸é—ªçƒé—®é¢˜ç‹¬ç«‹ï¼Œä½†åŒæ­¥å®Œæˆä»¥æå‡äº¤äº’ç¨³å®šæ€§ï¼‰ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
// å…¨å±€å˜é‡
private bool isPageLayoutSyncing = false; // é˜²æ­¢ PageLayout åˆ·æ–°é‡å…¥å¯¼è‡´é—ªçƒ
private IEnvelope lastPageLayoutEnv = null; // è®°å½•ä¸Šæ¬¡åŒæ­¥åˆ° PageLayout çš„èŒƒå›´ï¼Œé¿å…é‡å¤åˆ·æ–°

// OnExtentUpdated
// ä»…å±€éƒ¨åˆ·æ–°ï¼Œé¿å…è§¦å‘å…¨é‡é‡ç»˜å¯¼è‡´é—ªçƒ
axPageLayoutControl1.ActiveView.PartialRefresh(esriViewDrawPhase.esriViewGraphics, null, null);

private void axPageLayoutControl1_OnAfterScreenDraw(object sender, IPageLayoutControlEvents_OnAfterScreenDrawEvent e)
{
    if (isPageLayoutSyncing)
    {
        return;
    }
    try
    {
        isPageLayoutSyncing = true;
        // è·å–PageLayoutçš„å½“å‰è§†å›¾
        IActiveView pActiveview = (IActiveView)axPageLayoutControl1.ActiveView.FocusMap;
        // æ˜¾ç¤ºè½¬æ¢
        IDisplayTransformation pDTF = pActiveview.ScreenDisplay.DisplayTransformation;
        IEnvelope currentEnv = (IEnvelope)((IClone)axMapControl1.Extent).Clone();
        // è‹¥èŒƒå›´æœªå˜åŒ–ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤åˆ·æ–°é€ æˆé—ªçƒ
        if (lastPageLayoutEnv != null && EnvelopesEqual(lastPageLayoutEnv, currentEnv))
        {
            return;
        }
        lastPageLayoutEnv = currentEnv;
        // è®¾ç½®èŒƒå›´
        pDTF.VisibleBounds = currentEnv;
        CopyToPageLayout();
        // é¿å…å†æ¬¡è§¦å‘å…¨é‡åˆ·æ–°å¯¼è‡´é—ªçƒ
        pActiveview.PartialRefresh(esriViewDrawPhase.esriViewGraphics, null, null);
    }
    finally
    {
        isPageLayoutSyncing = false;
    }
}

private bool EnvelopesEqual(IEnvelope a, IEnvelope b, double tol = 1e-6)
{
    if (a == null || b == null)
    {
        return false;
    }
    return Math.Abs(a.XMin - b.XMin) < tol &&
            Math.Abs(a.YMin - b.YMin) < tol &&
            Math.Abs(a.XMax - b.XMax) < tol &&
            Math.Abs(a.YMax - b.YMax) < tol;
}

```

---

### 14. è§£å†³äº†`TOC`çŠ¶æ€æ— æ³•åŒæ­¥åˆ°å¸ƒå±€è§†å›¾çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼š
*   æ–°å†™æ–¹æ³• `SyncPageLayout`ï¼Œå°†`OnAfterScreenDraw`é€»è¾‘æ”¾åˆ°`SynPageLayout`é‡Œæ”¯æŒå¼ºåˆ¶åˆ·æ–°å¹¶é‡ç”¨é‡å…¥ä¿æŠ¤ä¸èŒƒå›´ç¼“å­˜é€»è¾‘ï¼›
*   åœ¨`TOC`å–æ¶ˆå‹¾é€‰åˆ†æ”¯ã€æ— æ•ˆç§»åŠ¨åˆ†æ”¯ã€æœ‰æ•ˆ`MoveLayer`ä¹‹åï¼Œä»¥åŠåˆ é™¤å›¾å±‚åï¼Œè°ƒç”¨`SyncPageLayout(true)`ï¼›åŒæ—¶ä»ä¿æŒé¹°çœ¼åŒæ­¥ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#

private void axPageLayoutControl1_OnAfterScreenDraw(object sender, IPageLayoutControlEvents_OnAfterScreenDrawEvent e)
{
    SyncPageLayout(false);
}

private void SyncPageLayout(bool force)
{
    if (isPageLayoutSyncing)
    {
        return;
    }
    try
    {
        isPageLayoutSyncing = true;
        IActiveView pActiveview = (IActiveView)axPageLayoutControl1.ActiveView.FocusMap;
        IDisplayTransformation pDTF = pActiveview.ScreenDisplay.DisplayTransformation;
        IEnvelope currentEnv = (IEnvelope)((IClone)axMapControl1.Extent).Clone();
        if (!force && lastPageLayoutEnv != null && EnvelopesEqual(lastPageLayoutEnv, currentEnv))
        {
            return;
        }
        lastPageLayoutEnv = currentEnv;
        pDTF.VisibleBounds = currentEnv;
        CopyToPageLayout();
        pActiveview.PartialRefresh(esriViewDrawPhase.esriViewGraphics, null, null);
    }
    finally
    {
        isPageLayoutSyncing = false;
    }
}

// åœ¨TOCçŠ¶æ€ä¸­è°ƒç”¨SynPageLayout
axMapControl1.ActiveView.Refresh();
Synchronize_axMapControl2();
SyncPageLayout(true);

```

---

### 15. è§£å†³äº†`PageLayout`æ— æ³•å³æ—¶åŒæ­¥ï¼ˆéœ€è¦å†æ¬¡ç‚¹å‡»å›¾å±‚æ‰å¯åˆ·æ–°ï¼‰`TOC`çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼šé‡‡ç”¨`BeginInvoke`å»¶è¿Ÿæ‰§è¡Œâ€œå•å‡»åˆ‡æ¢å¯è§æ€§â€åçš„åŒæ­¥åˆ·æ–°æ“ä½œï¼Œç¡®ä¿`TOC`å†…éƒ¨çŠ¶æ€åˆ‡æ¢å®Œæˆåå†åŒæ­¥`Map`ã€`Overview`ä¸ `PageLayout`ï¼Œä»è€Œè§£å†³å‹¾é€‰å›¾å±‚å¯è§æ€§å`PageLayout`æœªèƒ½å³æ—¶æ›´æ–°çš„é—®é¢˜ã€‚
>   `å»¶åä¸€å¸§`å¤ªæ™ºæ…§äº†

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
// Mouseup
 // è‹¥åªæ˜¯ç‚¹å‡»å‹¾é€‰/å–æ¶ˆå¯è§æ€§ï¼ˆæ— æ‹–æ‹½ï¼‰ï¼Œç«‹å³åŒæ­¥ Map/Overview/PageLayout
if (pLayer != null && e.button == 1)
{
    bool isClickOnly = true;
    if (pMoveRectPoint != null)
    {
        double dx = Math.Abs(e.x - pMoveRectPoint.X);
        double dy = Math.Abs(e.y - pMoveRectPoint.Y);
        isClickOnly = dx < 2 && dy < 2;
    }

    if (isClickOnly)
    {
        // å»¶åä¸€å¸§å†åˆ·æ–°ï¼Œç¡®ä¿ TOC å†…éƒ¨å·²æ›´æ–°å¯è§æ€§
        BeginInvoke(new Action(() =>
        {
            axMapControl1.ActiveView.Refresh();
            Synchronize_axMapControl2();
            SyncPageLayout(true);
        }));
        pMoveLayer = null;
        toIndex = -1;
        return;
        }
}
```
>   è¿™BUGå…¶å®æ˜¯ä¸Šä¸€ä¸ªBUGæ”¹å‡ºæ¥çš„...
    ä¸è¿‡è¿˜æŠŠä¹‹å‰é¹°çœ¼æ§ä»¶ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜æ”¹æ‰äº†ï¼Œå¾ˆèˆ’æœã€‚

---

### 16. è§£å†³äº†`AddDateTool`å·¥å…·é”™è¯¯åœ°åœ¨`æ•°æ®è§†å›¾`åº”ç”¨å’Œ`é‡å¤æ·»åŠ æ—¥æœŸå…ƒç´ `çš„é—®é¢˜

**1ï¼‰ä¸»è¦æ€è·¯**ï¼š
*   åœ¨ä¸»çª—ä½“åˆå§‹åŒ–æ—¶ï¼Œæ³¨å†Œ`tabControl1`çš„`SelectedIndexChanged`äº‹ä»¶ï¼Œåœ¨äº‹ä»¶å¤„ç†æ–¹æ³•ä¸­åˆ¤æ–­å½“å‰é€‰ä¸­çš„`TabIndex`;
*   ä¿®æ”¹`Enabled`å±æ€§ï¼Œé€šè¿‡`m_hookHelper.ActiveView is IPageLayout`è¿›è¡Œåˆ¤æ–­;
*   åœ¨`OnMouseDown`äº‹ä»¶ä¸­ï¼Œé€šè¿‡è·å–å¸ƒå±€è§†å›¾çš„`GraphicsContainer`ï¼Œéå†å¹¶åˆ é™¤å·²æœ‰çš„æ—¥æœŸå…ƒç´ `Name = "DateElement"`ï¼Œéšååœ¨`é¼ æ ‡ç‚¹å‡»ä½ç½®`åˆ›å»ºå¹¶æ·»åŠ æ–°çš„æ—¥æœŸæ–‡æœ¬å…ƒç´ ï¼Œå¹¶åˆ·æ–°è§†å›¾ä»¥å®Œæˆæ›´æ–°ã€‚

**2ï¼‰æ ¸å¿ƒä»£ç **ï¼š
``` C#
// Form_Load
// æ³¨å†ŒTabControlåˆ‡æ¢äº‹ä»¶ï¼Œå®ç°Buddyæ§ä»¶åˆ‡æ¢
tabControl1.SelectedIndexChanged += new EventHandler(tabControl1_SelectedIndexChanged);

// ä¸»çª—ä½“
 private void tabControl1_SelectedIndexChanged(object sender, EventArgs e)
{
    if (tabControl1.SelectedIndex == 0)
    {
        axToolbarControl1.SetBuddyControl(axMapControl1.Object);
    }
    else
    {
        axToolbarControl1.SetBuddyControl(axPageLayoutControl1.Object);
    }
}

#region Reapair1                
//if (m_hookHelper.ActiveView!=null)
if (m_hookHelper == null)
{
    return false;
} 
// ä»…åœ¨å¸ƒå±€è§†å›¾ä¸‹å¯ç”¨                
if (m_hookHelper.ActiveView is IPageLayout)                                
#endregion

#region Repair2_Add
// ç¡®ä¿åœ¨å¸ƒå±€è§†å›¾ä¸‹
if (m_hookHelper.ActiveView == null || !(m_hookHelper.ActiveView is IPageLayout))
{
    return;
}
// è·å–æ´»åŠ¨è§†å›¾
IActiveView activeView = m_hookHelper.ActiveView;
IGraphicsContainer graphicsContainer = activeView.GraphicsContainer;

// 1. åˆ é™¤å·²å­˜åœ¨çš„æ—¥æœŸå…ƒç´ 
graphicsContainer.Reset();
IElement pElement = graphicsContainer.Next();
System.Collections.ArrayList elementsToDelete = new System.Collections.ArrayList();
while (pElement != null)
{
    if (pElement is IElementProperties)
    {
        IElementProperties pElePro = pElement as IElementProperties;
        if (pElePro.Name == "DateElement")
        {
            elementsToDelete.Add(pElement);
        }
    }
    pElement = graphicsContainer.Next();
}

foreach (IElement ele in elementsToDelete)
{
    graphicsContainer.DeleteElement(ele);
}
#endregion

#region Reapair3
// è®¾ç½®å…ƒç´ åç§°ï¼Œä»¥ä¾¿ä¸‹æ¬¡è¯†åˆ«åˆ é™¤
IElementProperties elementProps = element as IElementProperties;
elementProps.Name = "DateElement";
// åˆ›å»ºç‚¹
//IPoint point = new PointClass();
//point = activeView.ScreenDisplay.DisplayTransformation.ToMapPoint(X, Y);
IPoint point = activeView.ScreenDisplay.DisplayTransformation.ToMapPoint(X, Y);
#endregion

#region Repair4
// å¢åŠ å…ƒç´ åˆ°å›¾å½¢ç»˜åˆ¶å®¹å™¨
//activeView.GraphicsContainer.AddElement(element, 0);
graphicsContainer.AddElement(element, 0);
#endregion
```
>   åˆ é™¤æ—¥æœŸå…ƒç´ å¯é€šè¿‡`ToolBar`çš„`Select Element`é€‰ä¸­`Key_Delete`åˆ é™¤

---

# äºŒã€GISå¼€å‘æœŸæœ«å¤§ä½œä¸š Â· åˆ†çº§è‰²å½©ç¬¦å·åŒ–åŠŸèƒ½

> **Created By:** è‚–å®¹åƒ
> **Date:** 2026.1.3
---

## åŠŸèƒ½æ¦‚è¿°
-   åœ¨ ArcEngine æ¡Œé¢ GIS é¡¹ç›®ä¸­ï¼Œé’ˆå¯¹çº¿/é¢è¦ç´ å›¾å±‚æä¾›æ•°å€¼å‹å­—æ®µçš„åˆ†çº§è‰²å½©æ¸²æŸ“ï¼Œæ”¯æŒ 2â€“5 çº§åˆ†çº§ï¼›
-   å†…ç½®å¤šç§åˆ†çº§æ–¹å¼ï¼ˆè‡ªç„¶é—´æ–­ã€ç­‰é—´è·ã€åˆ†ä½æ•°ã€å‡ ä½•é—´éš”ï¼‰ä¸é¢„è®¾æ¸å˜è‰²å¸¦ï¼ˆè“â†’çº¢ã€ç»¿â†’é»„ã€ç°â†’é»‘ã€æµ…çº¢â†’æ·±çº¢ï¼‰ï¼›
-   é€šè¿‡`public IClassBreaksRenderer BuildRenderer`æ–¹æ³•ï¼Œå®Œæˆåˆ†çº§æ¸²æŸ“å¹¶åˆ·æ–°åœ°å›¾è§†å›¾ï¼›
-   å­˜åœ¨è¾“å…¥æ ¡éªŒä¸å¼‚å¸¸æç¤ºï¼Œé¿å…éæ•°å€¼å­—æ®µã€æ— æ•ˆåˆ†çº§æ•°å¯¼è‡´çš„ç¨‹åºå´©æºƒã€‚

## è®¾è®¡æ€è·¯
>   å¼€å§‹çœ‹åˆ°è¿™ä¸ªè¦æ±‚å…¶å®æ˜¯æœ‰ç‚¹æ‡µçš„ï¼Œåˆšæ”¹å®Œ20ä¸ªBUGå·²ç»ç¥å¿—ä¸æ¸…äº†...åé¢ç»†çœ‹å†é—®äº†é—®aiï¼Œçœ‹äº†ä¸€ä¸‹Arcmapé‡Œé¢çš„åˆ†çº§ç¬¦å·åŒ–æ€è·¯å°±å·®ä¸å¤šæœ‰äº†ã€‚

>   1.å…¶å®å°±æ˜¯åœ¨`TOCControl`çš„å³é”®èœå•æ `contextMenuStrip1`é‡ŒåŠ ä¸€ä¸ª`åˆ†çº§ç¬¦å·åŒ–ToolStripMenuItem`ï¼Œå…ˆæŠŠâ€œæŒ‰é’®â€è®¾ç½®å¥½ï¼›

>   2.ç„¶åå°±è¦ç»™è¿™ä¸ªâ€œæŒ‰é’®â€è®¾å®šä¸€ä¸ªClickäº‹ä»¶`åˆ†çº§ç¬¦å·åŒ–ToolStripMenuItem_Click`ç»‘å®šä¸€ä¸ªçª—ä½“ï¼›

>   3.é‚£å°±æ–°å»ºä¸€ä¸ªçª—ä½“`FormClassifiedRenderer`ï¼Œæ ¹æ®è¦æ±‚åŠ ä¸Šå„ç§`Label`ã€`Comobox`ã€`numericUpDown`ä¹‹ç±»çš„æ§ä»¶ï¼Œå…·ä½“å¯å‚è€ƒé¡¹ç›®é‡Œçš„   [FormClassifiedRenderer.Designer.cs](Small_ArcGis/FormClassifiedRenderer.Designer.cs)   ;

>   4.`FormClassifiedRenderer`é‡Œçš„ä»£ç åªæ˜¯è°ƒç”¨å°è£…å¥½çš„æ¸²æŸ“ç±»å’Œä¸€äº›`MessageBox`çš„é”™è¯¯æç¤ºï¼Œä»£ç è§ï¼š            [FormClassifiedRenderer.cs](Small_ArcGis/FormClassifiedRenderer.cs);

>   5.é‚£ä¹ˆå°±è¦å†™æ¸²æŸ“ç±»äº†:`ClassifiedRendererHelper`ï¼Œå…¶å®è¿™ä¸ªæ˜¯å…ˆå†™çš„ï¼Œä¸ç„¶å’‹å†™çª—ä½“çš„è°ƒç”¨ä»£ç ...ä½†æ˜¯å¤§è‡´æ€è·¯æ˜¯è¿™æ ·è¿ç¯ä¸‹æ¥çš„;

>   6.å¯¹äº`ClassifiedRendererHelper`æ¥è¯´è¦è€ƒè™‘ï¼š"ç»™ä»€ä¹ˆåˆ†çº§ç€è‰²ï¼Ÿç”¨ä»€ä¹ˆåˆ†çº§æ–¹æ³•ï¼Ÿ
å¯¹åˆ†çº§æ•°æ®ä¼šæœ‰è¦æ±‚åš’ï¼Ÿåˆ†çº§å®Œæ€ä¹ˆç€è‰²ï¼Ÿç”¨å“ªäº›é¢œè‰²ç€è‰²ï¼Ÿ"ç­‰ä¸€ç³»åˆ—çš„é—®é¢˜ã€‚ä¸‹é¢ç»™å‡ºè¯¦ç»†è¯´æ˜ï¼š

-   ç›®æ ‡ï¼šç»™çº¿/é¢å›¾å±‚åšæ•°å€¼åˆ†çº§ç€è‰²ï¼›ArcEngine å·²å†…ç½®åˆ†çº§ç®—æ³•ï¼Œå› æ­¤ç›´æ¥ç”¨ COM æ¥å£è€Œéè‡ªç ”ç®—æ³•ï¼Œå‡å°‘è¯¯å·®ä¸å·¥ä½œé‡ï¼›
-   åˆ†çº§ç®—æ³•é€‰ç”¨ï¼š`ResolveClassifier` æ ¹æ®ç”¨æˆ·é€‰æ‹©è¿”å› ArcEngine å†…ç½® `IClassifyGEN` å®ç°ï¼ˆè‡ªç„¶é—´æ–­ã€ç­‰é—´è·ã€åˆ†ä½æ•°ã€å‡ ä½•é—´éš”ï¼‰ï¼Œä¿è¯åˆ†çº§ç»“æœä¸`ArcMap`ä¸€è‡´ï¼›
-   æ•°æ®å¤„ç†ï¼šåˆ†çº§ç®—æ³•éœ€è¦ç›´æ–¹å›¾æ•°æ®ï¼Œä½¿ç”¨ `BasicTableHistogramClass` + `IBasicHistogram.GetHistogram` ä»ç›®æ ‡å­—æ®µæŠ½å–å€¼/é¢‘æ¬¡ï¼›
-   åˆ†çº§åŒºé—´ç”Ÿæˆï¼š`classifier.Classify` äº§å‡ºæ–­ç‚¹ï¼Œéšåä»¥å®é™…è¿”å›çš„æ–­ç‚¹æ•°é‡é©±åŠ¨æ¸²æŸ“å™¨ï¼Œé¿å…å› æ ·æœ¬ä¸è¶³å¯¼è‡´çš„å¤±è´¥ã€‚
-   è‰²å¸¦ç”Ÿæˆï¼š`CreateColorRamp` é€šè¿‡ `AlgorithmicColorRamp` ç”Ÿæˆé¢„è®¾æ¸å˜ï¼Œç¡®ä¿æ¯çº§éƒ½æœ‰å¯ç”¨é¢œè‰²ï¼ŒåŒæ—¶ä¸`ArcEngine`æ ‡å‡†æ¥å£å…¼å®¹ï¼›
-   æ¸²æŸ“å™¨æ„é€ ï¼š`IClassBreaksRenderer` æŒ‰æ–­ç‚¹ã€æ ‡ç­¾ã€ç¬¦å·é€çº§å¡«å……ï¼Œå¹¶åº”ç”¨äº `IGeoFeatureLayer.Renderer` ååˆ·æ–°è§†å›¾ï¼›
-   æ¸²æŸ“å™¨ï¼š**è§£å†³åˆ†çº§å®Œæ€ä¹ˆç€è‰²çš„é—®é¢˜**ã€‚åˆ†çº§ç»“æœï¼ˆæ–­ç‚¹ã€é¢œè‰²ã€ç¬¦å·ï¼‰éœ€è¦ä»¥ ArcEngine æ”¯æŒçš„æ ‡å‡†æ¸²æŸ“å™¨å¯¹è±¡å­˜åœ¨ï¼Œæ‰èƒ½è¢«åœ°å›¾æ§ä»¶è¯†åˆ«ã€ä¿å­˜å’Œåˆ·æ–°ï¼›ç›´æ¥ä¿®æ”¹ç¬¦å·æ— æ³•è¡¨è¾¾åˆ†çº§è§„åˆ™ï¼Œæ„é€  `IClassBreaksRenderer` å¯è®© TOCã€å›¾ä¾‹ã€å¯¼å‡ºå’Œåç»­ç¼–è¾‘éƒ½å¤ç”¨åŒä¸€å¥—æ¸²æŸ“æè¿°ï¼›
-   è¾“å…¥æ ¡éªŒä¸å¼‚å¸¸ï¼šéæ•°å€¼å­—æ®µã€å­—æ®µç¼ºå¤±ã€åˆ†çº§æ•°è¶Šç•Œã€ç›´æ–¹å›¾ä¸å¯ç”¨ã€æ–­ç‚¹ä¸è¶³å‡ç«‹å³æŠ¥é”™ï¼Œé˜»æ–­é”™è¯¯æ¸²æŸ“ã€‚

## æ ¸å¿ƒä»£ç 
>   å±•ç¤º`ClassifiedRendererHelper`æ¸²æŸ“ç±»é‡Œçš„ä»£ç ï¼Œè¿™æ‰æ˜¯æ ¸å¿ƒï¼Œè¦å®ç°çš„åŠŸèƒ½éƒ½åœ¨è¿™å†™ã€‚

### ResolveClassifierï¼šé€‰æ‹©åˆ†çº§ç®—æ³•
``` C#
private IClassifyGEN ResolveClassifier(string methodName)
{
    string normalized = (methodName ?? string.Empty).Trim();
    switch (normalized)
    {
        case "ç­‰é—´è·åˆ†çº§":
            return new EqualIntervalClass();
        case "åˆ†ä½æ•°åˆ†çº§":
            return new QuantileClass();
        case "å‡ ä½•é—´éš”åˆ†çº§":
            return new GeometricalIntervalClass();
        // è‡ªç„¶é—´æ–­
        default: 
            return new NaturalBreaksClass();
    }
}
```

### BuildRendererï¼šæ„å»ºæ¸²æŸ“å™¨
``` C#
public IClassBreaksRenderer BuildRenderer(IFeatureLayer layer, string fieldName, int classCount, string methodName, string colorSchemeName)
{
    if (layer == null || layer.FeatureClass == null)
    {
        throw new InvalidOperationException("è¦ç´ ç±»ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œåˆ†çº§ç¬¦å·åŒ–ã€‚");
    }
        
    // ä»…æ”¯æŒçº¿/é¢å›¾å±‚
    esriGeometryType geometryType = layer.FeatureClass.ShapeType;
    if (geometryType != esriGeometryType.esriGeometryPolygon && geometryType != esriGeometryType.esriGeometryPolyline)
    {
        throw new NotSupportedException("ä»…æ”¯æŒé¢æˆ–çº¿è¦ç´ å›¾å±‚çš„åˆ†çº§ç¬¦å·åŒ–ã€‚");
    } 

    // æ•°å€¼å­—æ®µæ ¡éªŒ
    int fieldIndex = layer.FeatureClass.Fields.FindField(fieldName);
    if (fieldIndex < 0)
    {
        throw new InvalidOperationException("åˆ†çº§å­—æ®µä¸å­˜åœ¨ã€‚");
    }
    IField targetField = layer.FeatureClass.Fields.get_Field(fieldIndex);
    if (!IsNumericField(targetField))
    {
        throw new InvalidOperationException("è¯·é€‰æ‹©æ•°å€¼å‹å­—æ®µã€‚");
    }

    // åˆ†çº§æ•°æ ¡éªŒ
    if (classCount < 2 || classCount > 5)
    {
        throw new ArgumentOutOfRangeException("classCount", "åˆ†çº§æ•°éœ€åœ¨ 2 åˆ° 5 ä¹‹é—´ã€‚");
    }

    // é€‰æ‹©åˆ†ç±»å™¨
    IClassifyGEN classifier = ResolveClassifier(methodName);
    if (classifier == null)
    {
        throw new NotSupportedException("æš‚ä¸æ”¯æŒæ‰€é€‰åˆ†çº§æ–¹å¼ã€‚");
    } 

    // ç›´æ–¹å›¾è·å–
    ITableHistogram tableHistogram = new BasicTableHistogramClass();
    tableHistogram.Field = fieldName;
    tableHistogram.Table = layer.FeatureClass as ITable;
    IBasicHistogram basicHistogram = tableHistogram as IBasicHistogram;
    object dataValues = null; object dataFrequencies = null;
    basicHistogram.GetHistogram(out dataValues, out dataFrequencies);

    double[] numericValues = ToDoubleArray(dataValues);
    double[] numericFreqs = ToDoubleArray(dataFrequencies);
    if (numericValues == null || numericFreqs == null || numericValues.Length == 0)
    {
         throw new InvalidOperationException("åˆ†çº§å­—æ®µæœªåŒ…å«æœ‰æ•ˆæ•°æ®ã€‚");
    }
       
    int breakCount = classCount;
    classifier.Classify(numericValues, numericFreqs, ref breakCount);

    double[] classBreaks = ToDoubleArray(classifier.ClassBreaks);
    if (classBreaks == null || classBreaks.Length < 2)
    {
        throw new InvalidOperationException("ç”Ÿæˆåˆ†çº§æ–­ç‚¹å¤±è´¥ã€‚");
    }  

    // ä½¿ç”¨å®é™…è¿”å›çš„æ–­ç‚¹æ•°é‡
    int availableBreaks = classBreaks.Length - 1;
    int renderBreaks = Math.Min(breakCount, availableBreaks);

    // æ„é€ æ¸²æŸ“å™¨å¹¶å¡«å……åˆ†çº§
    IEnumColors colors = CreateColorRamp(colorSchemeName, renderBreaks);
    colors.Reset();

    IClassBreaksRenderer renderer = new ClassBreaksRendererClass();
    renderer.Field = fieldName;
    renderer.BreakCount = renderBreaks;
    renderer.SortClassesAscending = true;
    renderer.MinimumBreak = classBreaks[0];

    for (int i = 0; i < renderBreaks; i++)
    {
        IColor color = colors.Next();
        if (color == null) 
        { 
            colors.Reset(); color = colors.Next(); 
        }
        renderer.set_Break(i, classBreaks[i + 1]);
        renderer.set_Label(i, string.Format("{0:0.##} - {1:0.##}", classBreaks[i], classBreaks[i + 1]));
        renderer.set_Symbol(i, CreateSymbol(geometryType, color));
    }

    return renderer;
}
```

### CreateColorRampï¼šç”Ÿæˆæ¸å˜è‰²å¸¦
``` C#
private IEnumColors CreateColorRamp(string colorSchemeName, int classCount)
{
    AlgorithmicColorRamp colorRamp = new AlgorithmicColorRampClass();
    colorRamp.Size = classCount;
    colorRamp.Algorithm = esriColorRampAlgorithm.esriCIELabAlgorithm;

    string normalized = (colorSchemeName ?? string.Empty).Replace(" ", string.Empty);
    if (normalized.Contains("ç»¿"))
    {
        colorRamp.FromColor = CreateRgbColor(38, 166, 65);   // ç»¿
        colorRamp.ToColor = CreateRgbColor(255, 221, 85);    // é»„
    }
    else if (normalized.Contains("ç°"))
    {
        colorRamp.FromColor = CreateRgbColor(200, 200, 200); // ç°
        colorRamp.ToColor = CreateRgbColor(40, 40, 40);      // é»‘
    }
    else if (normalized.Contains("æµ…çº¢") || normalized.Contains("æ·±çº¢"))
    {
        colorRamp.FromColor = CreateRgbColor(255, 204, 204); // æµ…çº¢
        colorRamp.ToColor = CreateRgbColor(128, 0, 0);       // æ·±çº¢
    }
    else
    {
        colorRamp.FromColor = CreateRgbColor(0, 112, 192);   // è“
        colorRamp.ToColor = CreateRgbColor(192, 0, 0);       // çº¢
    }

    bool rampOk;
    colorRamp.CreateRamp(out rampOk);
    if (!rampOk)
    {
        throw new InvalidOperationException("ç”Ÿæˆè‰²å¸¦å¤±è´¥ã€‚");
    }
    return colorRamp.Colors;
}
```

## åŠŸèƒ½å®ç°æˆªå›¾
>   **è‡ªç„¶é—´æ–­åˆ†çº§ç•Œé¢**![NaturalBreaksClass1](Image/ClassfiedRenderer_Image/NaturalBreaksClass1.png)

>   **è‡ªç„¶é—´æ–­åˆ†çº§ç»“æœ**![NaturalBreaksClass2](Image/ClassfiedRenderer_Image/NaturalBreaksClass2.png)

>   **ç­‰é—´è·åˆ†çº§ç•Œé¢**![EqualIntervalClass1](Image/ClassfiedRenderer_Image/EqualIntervalClass1.png)

>   **ç­‰é—´è·åˆ†çº§ç»“æœ**![EqualIntervalClass2](Image/ClassfiedRenderer_Image/EqualIntervalClass2.png)

>   **åˆ†ä½æ•°åˆ†çº§ç•Œé¢**![QuantileClass1](Image/ClassfiedRenderer_Image/QuantileClass1.png)

>   **åˆ†ä½æ•°åˆ†çº§ç»“æœ**![QuantileClass2](Image/ClassfiedRenderer_Image/QuantileClass2.png)

>   **å‡ ä½•é—´éš”åˆ†çº§ç•Œé¢**![GeometricalIntervalClass1](Image/ClassfiedRenderer_Image/GeometricalIntervalClass1.png)

>   **å‡ ä½•é—´éš”åˆ†çº§ç»“æœ**![GeometricalIntervalClass12](Image/ClassfiedRenderer_Image/GeometricalIntervalClass2.png)

### [â–¶ç‚¹å‡»è§‚çœ‹æ¼”ç¤ºè§†é¢‘](Video/ClassfiedRenderer_Demo.mp4)

##  è‡³æš—æ—¶åˆ»(Darkest Time)
>   åˆšå¼€å§‹æˆ‘ä¸çŸ¥é“æœ‰ä»€ä¹ˆåˆ†çº§æ–¹æ³•ï¼Œæˆ‘å°±é—®äº†AIå†çœ‹äº†çœ‹Arcmapé‡Œçš„åˆ†çº§æ–¹æ³•ï¼Œæœ‰`è‡ªç„¶é—´éš”`ã€`å‡ ä½•é—´éš”`ã€`åˆ†ä½æ•°`ã€`ç­‰é—´è·`ã€`æ ‡å‡†å·®`ç­‰ã€‚æˆ‘å°±æƒ³ç€è¿™å‡ ä¸ªä¸€èµ·åšäº†å§ï¼Œåæ­£éƒ½æ˜¯è°ƒ`Engine`é‡Œçš„ï¼Œç„¶å`é¡ºé¡ºåˆ©åˆ©å¼€å¼€å¿ƒå¿ƒ`åœ°åšäº†ï¼Œç„¶åè¿è¡ŒæˆåŠŸï¼Œå¾ˆèˆ’æœã€‚

>   ç„¶åå¼€å§‹å®éªŒï¼Œå‘ç°`æ ‡å‡†å·®åˆ†çº§`æ€ä¹ˆæ”¹éƒ½åˆ†ä¸å‡ºæ¥ï¼Œå‰å‰ååæ”¹äº†ä¸€ä¸ªåŠå°æ—¶å¿«å´©äº†ï¼Œæœ€ç»å…¸çš„æ˜¯`MessageBox`å¼¹çª—æŠ¥é”™ï¼š"å¯¹COMç»„ä»¶çš„è°ƒç”¨è¿”å›äº†é”™è¯¯ HRESULT E_FAIL."è€Œä¸”æˆ‘ä¸€ç›´æ”¹çš„éƒ½æ˜¯æ©ç›–æˆ‘çš„BUGï¼Œä¸ºäº†ä¸æŠ¥é”™ä¸æ‹©æ‰‹æ®µï¼š
``` C#
int availableBreaks = classBreaks.Length - 1;
int renderBreaks = Math.Min(breakCount, availableBreaks);
```
>   è¿™å¯¼è‡´`renderer`æ˜¾ç¤ºçš„çº§æ•°å’Œç®—æ³•çœŸå®è®¡ç®—çš„çº§æ•°å·²ç»ä¸ä¸€è‡´äº†ï¼ŒçœŸå°±æ˜¯ä¸ºäº†ä¸æŠ¥é”™è€Œæ”¹äº†ï¼›

>   è€Œä¸”æ ‡å‡†å·®åˆ†çº§éƒ½æ˜¯3æˆ–5çº§ï¼Œä½†æˆ‘è®¾ç½®çš„æ˜¯2-5ï¼Œå°±æ›´å¯èƒ½å¯¼è‡´åˆ†ä¸å‡º;

>   æµ‹è¯•çš„`data`é‡Œçš„æ•°æ®é‡ä¹Ÿä¸å¤§ï¼Œæˆ‘æ„Ÿè§‰æ²¡æ³•æ‹Ÿåˆåˆ°æ­£æ€æ›²çº¿ï¼Œæ›´åˆ«è¯´ç®—æ ‡å‡†å·®äº†ï¼Œç®—å‡ºæ¥å°±ä¸€ä¸ªçº§åˆ«ï¼Œæˆ‘è¿˜è¦åˆ†3ç±»5ç±»ï¼Œä¸æŠ¥é”™æ‰å¥‡æ€ªäº†;

>   æ‰€ä»¥åœ¨ç»è¿‡ä¸€ä¸ªåŠå°æ—¶çš„æŒ£æ‰ä¹‹åï¼Œæˆ‘é€‰æ‹©æ”¾å¼ƒï¼Œæ„Ÿè§‰æ”¹ä¸å‡ºäº†ï¼Œæˆ‘çœŸç‡ƒå°½äº†ï¼Œå››ä¸ªè‚¯å®šæ¯”è¦æ±‚çš„ä¸¤ä¸ªæ›´å¥½...ğŸ¤¡æ”¾è¿‡è‡ªå·±



# ä¸‰ã€GISå¼€å‘æœŸæœ«å¤§ä½œä¸š Â· å¸ƒå±€è§†å›¾æ’å…¥è¦ç´ åŠŸèƒ½

> **Created By:** è‚–å®¹åƒ
> **Date:** 2026.1.4
---

## åŠŸèƒ½æ¦‚è¿°
-   åœ¨å¸ƒå±€è§†å›¾ä¸­æ”¯æŒæ’å…¥äº”ç±»åˆ¶å›¾è¦ç´ ï¼š`æ¯”ä¾‹å°º`ã€`æŒ‡åŒ—é’ˆ`ã€`æ ‡é¢˜`ã€`(æ™®é€š)æ–‡æœ¬`ã€`å›¾ä¾‹`ï¼›
-   äº”ç±»åˆ¶å›¾è¦ç´ åœ¨`æ•°æ®è§†å›¾`çŠ¶æ€æ— æ³•ç‚¹å‡»ï¼Œåˆ‡æ¢åˆ°`å¸ƒå±€è§†å›¾`å˜ä¸º`é«˜äº®å¯ç‚¹å‡»`ã€‚å‡ä¸ºç‚¹å‡»åå…‰æ ‡å˜ä¸º`â€œ+â€`ï¼Œ`å·¦é”®`ç‚¹å‡»å±å¹•ç¡®å®šæ’å…¥ä½ç½®è‡ªåŠ¨ç”Ÿæˆè¦ç´ ã€‚`æ¯”ä¾‹å°º`ã€`æŒ‡åŒ—é’ˆ`è¦ç´ ç›´æ¥ç”Ÿæˆï¼Œ`æ ‡é¢˜`ã€`æ–‡æœ¬`ã€`å›¾ä¾‹`è¦ç´ è·å–çª—ä½“å‚æ•°åè‡ªåŠ¨ç”Ÿæˆï¼›
-   `æ¯”ä¾‹å°º`ä¸ºâ€œæ¯”ä¾‹çº¿æ¯”ä¾‹å°ºâ€åªæ˜¾ç¤ºé¦–å°¾å’Œä¸­é—´åˆ»åº¦ï¼Œå•ä½ä¸º`km`;
-   `æŒ‡åŒ—é’ˆ`ä¸ºé»˜è®¤æŒ‡åŒ—é’ˆï¼Œæ˜¾ç¤º`Nã€Sã€Wã€E`å››ä¸ªæ–¹å‘;

-   `æ ‡é¢˜`ã€`æ–‡æœ¬`ã€`å›¾ä¾‹`ä¸‰ä¸ªè¦ç´ å‡é€šè¿‡çª—ä½“è·å–å‚æ•°ã€‚
    -   `æ ‡é¢˜`çª—ä½“`FormAddTitle`å¯æ”¹å˜`å†…å®¹`ä¸`å­—ä½“å¤§å°`ï¼Œå­—ä½“é™åˆ¶ä¸º`é»‘ä½“`ï¼›
    -   `æ–‡æœ¬`çª—ä½“`FormAddText`å¯æ”¹å˜`å†…å®¹`ã€`å­—ä½“å¤§å°`ä¸`å­—ä½“`ï¼ŒåŒ…æ‹¬ï¼š`å®‹ä½“`ã€`é»‘ä½“`ã€`å¾®è½¯é›…é»‘`ã€`Arial`ã€`Times New Roman`ä¾›ç”¨æˆ·é€‰æ‹©ï¼›
    -   `å›¾ä¾‹`çª—ä½“`FormAddLegend`å¯è·å–åŠ è½½æ•°æ®çš„å„ä¸ªå›¾å±‚æ•°æ®ã€‚é€‰ä¸­éœ€è¦æ·»åŠ çš„å›¾å±‚ï¼Œç‚¹å‡»æ·»åŠ `Button`å¯å°†å…¶åŠ å…¥å›¾ä¾‹é¡¹`ListBox`ä¸­ï¼Œé€‰ä¸­å›¾ä¾‹é¡¹`ListBox`ä¸­çš„å›¾å±‚æ•°æ®ç‚¹å‡»ç§»é™¤`Button`å¯å°†å…¶ç§»é™¤å›¾ä¾‹é¡¹`ListBox`ï¼Œé€šè¿‡ä¸Šç§»å’Œä¸‹ç§»`Button`å¯è°ƒæ•´å›¾ä¾‹ä¹‹é—´çš„é¡ºåºã€‚ç‚¹å‡»ç¡®å®š`Button`ä¼šå°†æ·»åŠ åˆ°å›¾ä¾‹é¡¹`ListBox`ä¸­çš„å›¾å±‚æ•°æ®ï¼Œä»ä¸Šåˆ°ä¸‹é¡ºåºç”Ÿæˆå›¾ä¾‹ã€‚

-   æ–‡æœ¬ç±»å…ƒç´ æ”¯æŒå­—å·ã€å­—ä½“ï¼ˆæ ‡é¢˜å›ºå®šä¸ºé»‘ä½“ï¼‰ï¼Œåœ°å›¾æ•´é¥°ç±»å…ƒç´ é‡‡ç”¨ ArcEngine æ ‡å‡† `MapSurround` å®ç°ï¼Œç¡®ä¿å¯¼å‡º/æ‰“å°ä¸€è‡´ï¼›
-   ç»Ÿä¸€è°ƒç”¨ `AddElementToLayout` åˆ·æ–°å¸ƒå±€è§†å›¾ï¼Œä¿éšœå³æ—¶é¢„è§ˆã€‚

## è®¾è®¡æ€è·¯
>   å’Œåˆ†çº§ç¬¦å·åŒ–ä¸€æ ·ï¼Œå…ˆæ˜¯çœ‹äº†çœ‹arcmapé‡Œé¢æ€ä¹ˆå®ç°çš„ã€‚è¿™ä¸ªæ€è·¯æ¸…æ™°äº›ã€‚

>   å°±æ˜¯åœ¨`menuStrip1`èœå•æ é‡ŒåŠ ä¸€ä¸ª`æ’å…¥ToolStripMenuItem`ï¼Œé‡Œé¢å†åŠ `æ¯”ä¾‹å°º`ã€`æŒ‡åŒ—é’ˆ`ã€`æ ‡é¢˜`ã€`æ–‡æœ¬`ã€`å›¾ä¾‹`ã€‚æœäº†ä¸€ä¸‹èµ„æ–™ï¼Œæ˜ç¡®äº†å…·ä½“çš„æ€è·¯ï¼š

1)  `æ¯”ä¾‹å°º`æ”¹æˆæ¯”ä¾‹çº¿çš„å½¢å¼ï¼Œé»˜è®¤çš„å¥½åƒæ˜¯é‚£ä¸ªé»‘ç™½ç›¸é—´çš„ï¼Œå¤ªä¸‘äº†ï¼›

2)  `æŒ‡åŒ—é’ˆ`ç”¨é»˜è®¤çš„ï¼Œå¦‚æœè¦ç”¨åˆ«çš„è¿˜å¾—åŠ è½½ä¸€äº›åº“ï¼Œæˆ‘è¯•äº†ä¸€ä¸‹ï¼Œå¤±è´¥äº†ï¼Œæœ‰äº†æ˜¨å¤©çš„åˆ†çº§ç¬¦å·çš„ç»éªŒï¼Œæˆ‘è¿˜æ˜¯é€‰æ‹©é»˜è®¤æ ·å¼äº†ï¼›

3)  `æ ‡é¢˜`å’Œ`æ–‡æœ¬`å…¶å®çª—ä½“å¾ˆåƒï¼Œä½†æˆ‘ä¸æƒ³å¤ç”¨ï¼Œæˆ‘å°±æ€•å‡ºä¸€äº›ç¨€å¥‡å¤æ€ªçš„BUGï¼Œæ”¹å®Œ20ä¸ªBUGåæ€•äº†ï¼Œè°ƒç”¨ä¸ªçª—ä½“éƒ½ä¸æ•¢ä¹±å†™äº†ã€‚å¤ç”¨çš„è¯è¿˜å¾—è€ƒè™‘æ€ä¹ˆåœ¨æ ‡é¢˜çª—ä½“é‡ŒæŠŠå­—ä½“é€‰é¡¹ç¦ç”¨äº†ï¼Œç›´æ¥æŠŠ`lblFont`å’Œ`cmbFont`çš„`Visible`è®¾æˆ`False`ï¼Œå°±è«åå…¶å¦™ç©ºäº†ä¸€å—ï¼Œç´¢æ€§å†å¼€ä¸ªæ–°çª—ä½“å¥½äº†ã€‚ä»£ç å‚è§ï¼š[Small_ArcGis/FormAddText.cs](Small_ArcGis/FormAddText.cs)ã€[Small_ArcGis/FormAddTitle.cs](Small_ArcGis/FormAddTitle.cs);

4)  `å›¾ä¾‹`è¿™ä¸ªçª—ä½“æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå€Ÿé‰´äº†ä¸€ä¸‹arcmapé‡Œçš„åšæ³•ï¼Œæ‹‰äº†ä¸€ä¸ªçª—ä½“å‡ºæ¥ä»£ç å‚è§ï¼š[Small_ArcGis/FormAddLegend.cs](Small_ArcGis/FormAddLegend.cs)ã€‚

>   æ¥ç€å°±æ˜¯åœ¨ä¸»çª—ä½“å†™è°ƒç”¨è¿™å‡ ä¸ªçª—ä½“çš„ä»£ç ï¼ŒPageLayoutçš„ç‚¹å‡»äº‹ä»¶ï¼Œè¿™å‡ ä¸ªè¦ç´ çš„ç”Ÿæˆé€»è¾‘ï¼Œä¸‹é¢ç»™å‡ºè¯¦ç»†è¯´æ˜ï¼š

1)  åœ°å›¾æ’å…¥è¦ç´ å¿…é¡»æ”¾ç½®åœ¨ç‰¹å®šçš„åæ ‡ä½ç½®ã€‚ä¸ºäº†è¾¾åˆ°`å…ˆé€‰å·¥å…·ï¼Œåç‚¹åœ°å›¾`ç¡®å®šä½ç½®çš„æ•ˆæœï¼Œé‡‡ç”¨äº†çŠ¶æ€æœºæ¨¡å¼(`OpenGL`ä¹Ÿæ˜¯çŠ¶æ€æœº...è¢«`è®¡ç®—æœºå›¾å½¢å­¦`é€¼ç–¯çš„ä¸€ç”Ÿ)ã€‚å› æ­¤åˆ©ç”¨`InsertMode`æšä¸¾æ ‡è®°å½“å‰å¾…æ’å…¥çš„è¦ç´ ç±»å‹ã€‚é€šè¿‡ `PageLayoutOnMouseDown`è·å–ç”¨æˆ·ç‚¹å‡»çš„å±å¹•åæ ‡ï¼Œå¹¶ç«‹å³é€šè¿‡`DisplayTransformation`è½¬æ¢ä¸º`é¡µé¢åœ°å›¾åæ ‡ï¼ˆMap Pointï¼‰`;

2)  `å›¾ä¾‹`ã€`æ¯”ä¾‹å°º`ã€`æŒ‡åŒ—é’ˆ`ï¼ˆåŸºäº`IMapSurround`æ¥å£å¼€å‘ï¼‰ä¸‰ä¸ªè¦ç´ æ˜¯ä¸å›¾å±‚æ•°æ®`åŠ¨æ€å…³è”`çš„ï¼Œå³ï¼šæŒ‡åŒ—é’ˆéœ€è¦çŸ¥é“åœ°å›¾çš„æ–¹å‘ï¼Œæ¯”ä¾‹å°ºéœ€è¦çŸ¥é“åœ°å›¾çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œå›¾ä¾‹éœ€è¦è¯»å–å›¾å±‚åˆ—è¡¨ã€‚è¿™äº›è¦ç´ ä¸èƒ½ç”¨ä¸€ä¸ªå›ºå®šçš„æ•°å€¼ç”Ÿæˆï¼Œå¿…é¡»æ”¾åˆ°ä¸€ä¸ªå…·ä½“çš„åœ°å›¾æ•°æ®æ¡†ä¸Šã€‚å› æ­¤ï¼Œå¿…é¡»ç¼–å†™`GetMapFrame`æ–¹æ³•éå†`IGraphicsContainer`ï¼Œæ‰¾åˆ°å½“å‰æ¿€æ´»çš„`IMapFrame`,å³æ•°æ®è§†å›¾å®¹å™¨ï¼Œä¸ºåç»­åˆ›å»ºçš„å¯¹è±¡æä¾›`æ•°æ®æº`ï¼›

3)  `æ ‡é¢˜`ã€`æ–‡æœ¬`åˆ™æ˜¯`é™æ€è¦ç´ `ï¼Œä¸ä¸å›¾å±‚æ•°æ®ç›¸å…³è”ï¼Œç”¨æˆ·æƒ³ç”Ÿæˆä»€ä¹ˆå°±ç”Ÿæˆä»€ä¹ˆ;

4)  å› æ­¤éœ€è¦æ ¹æ®è¿™ä¸¤ç§ä¸åŒçš„è¦ç´ éœ€è¦åˆ†åˆ«å¯¹å…¶è¿›è¡Œæ„å»ºï¼Œå°†å…¶æ”¾åˆ°`PageLayout`ä¸Šï¼›

5)   é™æ€è¦ç´ æ„å»º (`æ ‡é¢˜`ã€`æ–‡æœ¬`)ï¼šä½¿ç”¨`ITextElement`æ¥å£åˆ›å»ºæ–‡æœ¬å¯¹è±¡ï¼Œ`ITextSymbol`å®šä¹‰å­—ä½“æ ·å¼ï¼ˆå­—ä½“ç±»å‹ã€å­—ä½“å¤§å°ï¼‰ï¼›

6)  åŠ¨æ€è¦ç´ æ„å»º (`å›¾ä¾‹`ã€`æ¯”ä¾‹å°º`ã€`æŒ‡åŒ—é’ˆ`)ï¼š`IMapSurround`åªæ˜¯é€»è¾‘å¯¹è±¡ï¼Œä¸èƒ½ç›´æ¥ç”»åœ¨å¸ƒå±€ä¸Šï¼Œå› æ­¤å¿…é¡»åˆ›å»ºä¸€ä¸ªå›¾å½¢å®¹å™¨ `IMapSurroundFrame`æ¥â€œæ”¾ç½®â€å®ƒã€‚`MapSurroundFrame.MapFrame = mapFrame`æˆåŠŸå°†`IMapSurround`æ”¾åˆ°`IMapSurroundFrame`é‡Œï¼Œå®ç°ç»‘å®šï¼›

7)  ä¸ºäº†ä¸å†™å¯¹åº”å„ä¸ªè¦ç´ æ·»åŠ åˆ°`PageLayout`çš„ä»£ç ï¼Œå› æ­¤å†™ä¸€ä¸ª`AddElementToLayout`æ–¹æ³•å°è£…ã€‚å°†ä¸Šè¿°æ­¥éª¤ç”Ÿæˆçš„è¦ç´ `IElement`ï¼ˆæ— è®ºæ˜¯`TextElement`è¿˜æ˜¯`MapSurroundFrame`ï¼‰ç»Ÿä¸€æ·»åŠ åˆ°è§†å›¾ä¸­;

8)  ä¸ºäº†åŒæ­¥æ˜¾ç¤ºï¼Œä¹Ÿä¸ºäº†ä¸å†å‡ºç°é—ªçƒBUGï¼ˆåˆæƒ³èµ·äº†æˆ‘çš„ä»£ç ä¹‹å‰å¸ƒå±€è§†å›¾ä¸€ç›´é—ªçƒçš„æ‚²ä¼¤å›å¿†äº†ğŸ˜­ï¼‰ï¼Œå› æ­¤è°ƒç”¨`ActiveView.PartialRefresh`,åªåˆ·æ–° `esriViewGraphics`ï¼ˆå›¾å½¢å±‚ï¼‰ï¼Œä¸å†é‡ç»˜è€—æ—¶çš„`esriViewGeography`ï¼ˆåœ°ç†æ•°æ®å±‚ï¼‰ï¼Œå®Œç¾åŒæ­¥ä¹Ÿä¸é—ªçƒã€‚

## æ ¸å¿ƒä»£ç 

### åˆ©ç”¨ InsertMode æšä¸¾æ ‡è®°å½“å‰å¾…æ’å…¥çš„è¦ç´ ç±»å‹
``` C#
private enum InsertMode
{
    None = 0,
    Title = 1,
    Text = 2,
    Legend = 3,
    ScaleBar = 4,
    NorthArrow = 5
}

private void BeginInsertMode(InsertMode mode)
{
    if (!_isLayoutView)
    {
        return;
    }

    _currentInsertMode = mode;
    axPageLayoutControl1.MousePointer = esriControlsMousePointer.esriPointerCrosshair;
}
```

### PageLayoutMouseDownäº‹ä»¶
``` C#
private void axPageLayoutControl1_OnMouseDown(object sender, IPageLayoutControlEvents_OnMouseDownEvent e)
{
    if (_currentInsertMode == InsertMode.None)
    {
        return;
    }

    // å°†å±å¹•åæ ‡(Pixel)è½¬æ¢ä¸ºå¸ƒå±€è§†å›¾çš„åœ°å›¾åæ ‡(MapPoint)
    // å¯¹åº”è®¾è®¡æ€è·¯ï¼šDisplayTransformationè½¬æ¢
    IPoint mapPoint = axPageLayoutControl1.ActiveView.ScreenDisplay.DisplayTransformation.ToMapPoint(e.x, e.y);

    try
    {
        switch (_currentInsertMode)
        {
            case InsertMode.Title:
                InsertTitleAt(mapPoint);
                break;
            case InsertMode.Text:
                InsertTextAt(mapPoint);
                break;
            case InsertMode.Legend:
                InsertLegendAt(mapPoint);
                break;
            case InsertMode.ScaleBar:
                InsertScaleBarAt(mapPoint);
                break;
            case InsertMode.NorthArrow:
                InsertNorthArrowAt(mapPoint);
                break;
        }
    }
    finally
    {
        ResetInsertMode();      // é‡ç½®çŠ¶æ€
    }
}

```

### GetMapFrameæ–¹æ³•éå†IGraphicsContainer
``` C#
// éå†å®¹å™¨è·å–å½“å‰æ¿€æ´»çš„ MapFrameï¼ˆæ•°æ®æºï¼‰
private IMapFrame GetMapFrame()
{
    IGraphicsContainer container = axPageLayoutControl1.ActiveView.GraphicsContainer;
    // æŸ¥æ‰¾ä¸ FocusMap å…³è”çš„æ¡†æ¶
    return container.FindFrame(axPageLayoutControl1.ActiveView.FocusMap) as IMapFrame;
}
```

### é™æ€è¦ç´ æ„å»ºï¼šæ–‡æœ¬ã€æ ‡é¢˜
``` C#
// æ–‡æœ¬
private void InsertTextAt(IPoint anchor)
{
    using (var dlg = new FormAddText())
    {
        if (dlg.ShowDialog() != DialogResult.OK)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(dlg.TextContent))
        {
            MessageBox.Show("æ–‡æœ¬å†…å®¹ä¸èƒ½ä¸ºç©º", "æ’å…¥æ–‡æœ¬", MessageBoxButtons.OK, MessageBoxIcon.Information);
            return;
        }

        ITextElement textElement = new TextElementClass();
        textElement.Text = dlg.TextContent;

        ITextSymbol textSymbol = new TextSymbolClass
        {
            Color = CreateRgbColor(0, 0, 0),
            Size = dlg.FontSize,
            Font = new StdFontClass
            {
                Name = dlg.FontName,
                Size = (decimal)dlg.FontSize
            } as IFontDisp
        };

        textElement.Symbol = textSymbol;

        IElement element = textElement as IElement;
        element.Geometry = anchor;

        AddElementToLayout(element);
    }
}

// æ ‡é¢˜
private void InsertTitleAt(IPoint anchor)
{
    using (var dlg = new FormAddTitle())
    {
        if (dlg.ShowDialog() != DialogResult.OK)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(dlg.TitleText))
        {
            MessageBox.Show("æ ‡é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º", "æ’å…¥æ ‡é¢˜", MessageBoxButtons.OK, MessageBoxIcon.Information);
            return;
        }

        ITextElement textElement = new TextElementClass();
        textElement.Text = dlg.TitleText;

        ITextSymbol textSymbol = new TextSymbolClass
        {
            Color = CreateRgbColor(0, 0, 0),
            Size = dlg.FontSize,
            Font = new StdFontClass
            {
                Name = "é»‘ä½“",
                Size = (decimal)dlg.FontSize
            } as IFontDisp
        };

        textElement.Symbol = textSymbol;

        IElement element = textElement as IElement;
        element.Geometry = anchor;

        AddElementToLayout(element);
    }
}
```

### åŠ¨æ€è¦ç´ æ„å»ºï¼šæ¯”ä¾‹å°ºã€å›¾ä¾‹ã€æŒ‡åŒ—é’ˆ
``` C#
// æ¯”ä¾‹å°º
private void InsertScaleBarAt(IPoint anchor)
{
    IMapFrame mapFrame = GetMapFrame();
    if (mapFrame == null)
    {
        MessageBox.Show("æœªæ‰¾åˆ°åœ°å›¾æ¡†æ¶ï¼Œæ— æ³•æ·»åŠ æ¯”ä¾‹å°ºã€‚", "æ’å…¥æ¯”ä¾‹å°º", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        return;
    }

    // ä½¿ç”¨ScaleLineClassåˆ›å»ºæ¯”ä¾‹çº¿æ ·å¼
    IScaleBar scaleBar = new ScaleLineClass();
    scaleBar.Units = esriUnits.esriKilometers;
    scaleBar.UnitLabel = "km";
    scaleBar.LabelPosition = esriVertPosEnum.esriBelow;
    scaleBar.Division = 1;           // ä¸»åˆ»åº¦æ•°é‡ä¸º1ï¼ˆä¸¤ä¸ªåˆ»åº¦ç‚¹ï¼š0å’Œç»ˆç‚¹ï¼‰
    scaleBar.Subdivisions = 1;       // ä¸éœ€è¦ç»†åˆ†
    scaleBar.DivisionsBeforeZero = 0; // é›¶ç‚¹ä¹‹å‰æ— åˆ»åº¦
    scaleBar.LabelFrequency = esriScaleBarFrequency.esriScaleBarDivisions;

    IMapSurroundFrame surroundFrame = new MapSurroundFrameClass
    {
        MapSurround = scaleBar as IMapSurround,
        MapFrame = mapFrame
    };

    IElement element = (IElement)surroundFrame;
    IEnvelope env = new EnvelopeClass();
    double width = 2.5;
    double height = 0.5;
    env.PutCoords(anchor.X, anchor.Y, anchor.X + width, anchor.Y + height);
    element.Geometry = env;

    AddElementToLayout(element);
}

// å›¾ä¾‹
private void InsertLegendAt(IPoint anchor)
{
    IMapFrame mapFrame = GetMapFrame();
    if (mapFrame == null)
    {
        MessageBox.Show("æœªæ‰¾åˆ°åœ°å›¾æ¡†æ¶ï¼Œæ— æ³•æ·»åŠ å›¾ä¾‹ã€‚", "æ’å…¥å›¾ä¾‹", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        return;
    }

    using (var dlg = new FormAddLegend(mapFrame.Map))
    {
        if (dlg.ShowDialog() != DialogResult.OK)
        {
            return;
        }

        if (dlg.SelectedLayers == null || dlg.SelectedLayers.Count == 0)
        {
            MessageBox.Show("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå›¾å±‚ç”¨äºå›¾ä¾‹ã€‚", "æ’å…¥å›¾ä¾‹", MessageBoxButtons.OK, MessageBoxIcon.Information);
            return;
        }

        IMapSurroundFrame surroundFrame = mapFrame.CreateSurroundFrame(new UIDClass { Value = "esriCarto.Legend" }, null);

        ILegend legend = surroundFrame != null ? surroundFrame.MapSurround as ILegend : null;
        if (legend == null)
        {
            MessageBox.Show("åˆ›å»ºå›¾ä¾‹å¤±è´¥ã€‚", "æ’å…¥å›¾ä¾‹", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            return;
        }
        // å…ˆè‡ªåŠ¨å¡«å……å›¾ä¾‹ä»¥è·å–é»˜è®¤è®¾ç½®
        legend.AutoAdd = false;
        legend.AutoReorder = false;
        legend.AutoVisibility = true;
        // æ¸…é™¤é»˜è®¤çš„å›¾ä¾‹é¡¹
        legend.ClearItems();

        foreach (ILayer layer in dlg.SelectedLayers)
        {
            // åˆ›å»ºæ–°çš„å›¾ä¾‹é¡¹å¹¶å…³è”å›¾å±‚
            ILegendItem legendItem = new HorizontalLegendItemClass();
            legendItem.Layer = layer;
            legendItem.ShowDescriptions = false;
            //legendItem.ShowHeadings = false;
            legendItem.ShowLabels = true;
            legendItem.ShowLayerName = true;

            // è®¾ç½®å›¾ä¾‹é¡¹çš„åˆ—æ•°
            legendItem.Columns = 1;
            legendItem.KeepTogether = true;

            legend.AddItem(legendItem);
        }

        surroundFrame.MapFrame = mapFrame;

        IElement element = (IElement)surroundFrame;
        IEnvelope env = new EnvelopeClass();
        double width = 2.5;
        double height = 3.0;
        env.PutCoords(anchor.X, anchor.Y, anchor.X + width, anchor.Y + height);
        element.Geometry = env;

        AddElementToLayout(element);
    }
}

// æŒ‡åŒ—é’ˆ
private void InsertNorthArrowAt(IPoint anchor)
{
    IMapFrame mapFrame = GetMapFrame();
    if (mapFrame == null)
    {
        MessageBox.Show("æœªæ‰¾åˆ°åœ°å›¾æ¡†æ¶ï¼Œæ— æ³•æ·»åŠ æŒ‡åŒ—é’ˆã€‚", "æ’å…¥æŒ‡åŒ—é’ˆ", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        return;
    }

    IMarkerNorthArrow northArrow = new MarkerNorthArrowClass();
    INorthArrow arrow = northArrow as INorthArrow;
    if (arrow != null)
    {
        arrow.Color = CreateRgbColor(0, 0, 0);
    }

    IMapSurroundFrame surroundFrame = new MapSurroundFrameClass
    {
        MapSurround = northArrow as IMapSurround,
        MapFrame = mapFrame
    };

    IElement element = (IElement)surroundFrame;
    IEnvelope env = new EnvelopeClass();
    double size = 1.0;
    env.PutCoords(anchor.X, anchor.Y, anchor.X + size, anchor.Y + size);
    element.Geometry = env;

    AddElementToLayout(element);
}
```

### ç»Ÿä¸€æ·»åŠ è¦ç´ ã€åŠæ—¶åŒæ­¥é˜²é—ªçƒ
``` C#
private void AddElementToLayout(IElement element)
{
    // 1. è·å–å¸ƒå±€è§†å›¾çš„å›¾å½¢å®¹å™¨
    IGraphicsContainer container = axPageLayoutControl1.ActiveView.GraphicsContainer;
    
    // 2. æ·»åŠ å…ƒç´  (Z-order 0 è¡¨ç¤ºæœ€ä¸Šå±‚)
    container.AddElement(element, 0);
    
    // 3. å±€éƒ¨åˆ·æ–° (å…³é”®ä¼˜åŒ–)
    // åªåˆ·æ–° esriViewGraphics (å›¾å½¢å±‚)ï¼Œä¸é‡ç»˜ Geography (åœ°å›¾æ•°æ®å±‚)
    // å½»åº•è§£å†³é—ªçƒé—®é¢˜
    axPageLayoutControl1.ActiveView.PartialRefresh(esriViewDrawPhase.esriViewGraphics, null, null);
}
```

##  åŠŸèƒ½å®ç°æˆªå›¾
>   **æ·»åŠ æ–‡æœ¬ç•Œé¢**![NaturalBreaksClass1](Image/Add_Image/Text1.png)

>   **æ·»åŠ æ–‡æœ¬ç»“æœ**![NaturalBreaksClass1](Image/Add_Image/Text2.png)

>   **æ·»åŠ æ¯”ä¾‹å°ºç»“æœ**![NaturalBreaksClass1](Image/Add_Image/ScaleBar.png)

>   **æ·»åŠ å›¾ä¾‹ç•Œé¢**![NaturalBreaksClass1](Image/Add_Image/Legend1.png)

>   **æ·»åŠ å›¾ä¾‹ç»“æœ**![NaturalBreaksClass1](Image/Add_Image/Legend2.png)

>   **æ·»åŠ æŒ‡åŒ—é’ˆç»“æœ**![NaturalBreaksClass1](Image/Add_Image/NorthArrow.png)

>   **æ·»åŠ æ ‡é¢˜ç•Œé¢**![NaturalBreaksClass1](Image/Add_Image/Title1.png)

>   **æ·»åŠ æ ‡é¢˜ç»“æœ**![NaturalBreaksClass1](Image/Add_Image/Legend2.png)

### [â–¶ç‚¹å‡»è§‚çœ‹æ¼”ç¤ºè§†é¢‘](Video/Add_Demo.mp4)



# å››ã€GISå¼€å‘æœŸæœ«å¤§ä½œä¸š Â· å¸ƒå±€è§†å›¾æ‰“å°ä¸å¯¼å‡ºåŠŸèƒ½æŠ€æœ¯æ–‡æ¡£

> **Created By:** è‚–å®¹åƒ
> **Date:** 2026.1.5
---

## åŠŸèƒ½æ¦‚è¿°
-   å®ç°äº†åŸºäº`å¸ƒå±€è§†å›¾`ï¼ˆPageLayoutï¼‰çš„`åœ°å›¾æ‰“å°é¢„è§ˆ`ä¸`å¤šæ ¼å¼å¯¼å‡º`åŠŸèƒ½ï¼›

-   æ–°å»ºç‹¬ç«‹çš„æ‰“å°/å¯¼å‡ºè®¾ç½®çª—ä½“`FormPrint`ï¼Œ`PictureBox`æ”¯æŒå®æ—¶æ‰“å°é¢„è§ˆã€‚é¢„è§ˆå›¾ä¼šæ ¹æ®çº¸å¼ è®¾ç½®å®æ—¶åŒæ­¥åˆ·æ–°ï¼Œè¾¾åˆ°`æ‰€è§å³æ‰€å¾—`çš„æ•ˆæœï¼›

-   æ”¯æŒå¤šç§çº¸å¼ è§„æ ¼è®¾ç½®ï¼šåŒ…æ‹¬ `A4`ã€`A3`ã€`A2`ã€`Letter`ï¼Œå¹¶æ”¯æŒ`æ¨ªå‘`ä¸`çºµå‘`ä¸¤ç§æ’ç‰ˆæ–¹å‘åˆ‡æ¢ï¼›

-   æ”¯æŒ`PDFæ–‡æ¡£å¯¼å‡º`ï¼šåº•å±‚é€»è¾‘å®ç°äº†é«˜ç²¾åº¦çš„`PDF`å¯¼å‡ºåŠŸèƒ½ï¼Œæ”¯æŒé€‰æ‹©`ç³»ç»Ÿæ‰“å°æœº`ä½œä¸ºé…ç½®å‚è€ƒï¼›

-   æ”¯æŒ`å›¾ç‰‡æ ¼å¼å¯¼å‡º`ï¼šæ”¯æŒå°†å½“å‰å¸ƒå±€è§†å›¾å¯¼å‡ºä¸º `JPG` æˆ– `PNG` æ ¼å¼å›¾ç‰‡ï¼Œå¹¶æ”¯æŒè‡ªå®šä¹‰åˆ†è¾¨ç‡`DPI`ï¼ˆ200-600ï¼‰ï¼›

-   **å¯¼å‡ºè·¯å¾„äº¤äº’**ï¼š
    -   æµè§ˆæŒ‰é’®é‡‡ç”¨ `SaveFileDialog`ï¼Œå…è®¸ç”¨æˆ·åœ¨å¼¹çª—ä¸­ç›´æ¥ä¿®æ”¹`æ–‡ä»¶å`å’Œ`æ–‡ä»¶è·¯å¾„`ï¼›

    -   å¯¼å‡ºæŒ‰é’®é€»è¾‘ä¼˜åŒ–ï¼šç›´æ¥è¯»å–è·¯å¾„æ–‡æœ¬æ¡†å†…å®¹æ‰§è¡Œå¯¼å‡ºï¼Œä¸å†é‡å¤å¼¹å‡º `SaveFileDialog`å¯¹è¯æ¡†ï¼›

    -   æ”¯æŒ`è‡ªåŠ¨åŒ–è·¯å¾„ä¸åç§°ç®¡ç†`ï¼šè®¾ç½®é»˜è®¤å¯¼å‡ºè·¯å¾„`defaultFileName`ã€è‡ªåŠ¨æ ¹æ®å½“å‰æ—¥æœŸ`yymmdd`ç”Ÿæˆé»˜è®¤æ–‡ä»¶åï¼ˆå¦‚`åœ°å›¾å¯¼å‡º_250105`ï¼‰ï¼Œå¹¶æ ¹æ®å¯¼å‡ºæ ¼å¼è‡ªåŠ¨ä¿®æ­£åç¼€åã€‚


## è®¾è®¡æ€è·¯
>   è¿™æ¬¡çœ‹è§è¦æ±‚ä¹Ÿæ˜¯å’Œå‰ä¸¤æ¬¡ä¸€æ ·ï¼Œå…ˆå»çœ‹äº†arcmapé‡Œé¢çš„æ‰“å°å’Œå¯¼å‡ºç•Œé¢æ˜¯å’‹æ ·çš„ã€‚arcmapé‡Œçš„æ‰“å°å¤ªé«˜çº§äº†ï¼Œä¸€ä¸ªæ‰“å°çª—ä½“èƒ½è¿ç€ä¸‰ä¸ªå…¶ä»–çª—ä½“ã€‚æƒ³åˆ°åœ¨è¯¾ä¸Šå†™è¿‡ä¸€ä¸ªå¯¼å‡ºç•Œé¢ï¼Œç»“åˆäº†ä¸¤è€…ï¼Œæ‹‰å‡ºäº†ä¸€ä¸ªçª—ä½“ã€‚

>   è¿™ä¸ªçª—ä½“æˆ‘æ‹‰äº†å¿«ä¸¤ä¸ªå°æ—¶...ä¸€ç›´åœ¨çº ç»“æ€ä¹ˆæ‹‰ç›´è§‚ä¹Ÿç¾è§‚ï¼Œè€å¸ˆåœ¨è¯¾ä¸Šä¹Ÿå±•ç¤ºè¿‡ï¼Œä½†æˆ‘è§‰å¾—é‚£ä¸ªåˆè¦å¼¹å‡ºå‡ ä¸ªæ–°çª—ä½“æ—¢ä¸ç›´è§‚ä¹Ÿéº»çƒ¦ï¼Œè€Œä¸”å¥½åƒæ²¡æ³•å®æ—¶æ˜¾ç¤ºé¢„è§ˆã€‚æœ€åæ‹‰å‡ºäº†ä¸€ä¸ªè¿™æ ·çš„çª—ä½“![FormPrint](Image/PrintAndOutPut_Image/PrintForm.png)
æˆ‘å·²ç»å¾ˆæ»¡æ„äº†ï¼Œè™½ç„¶ä¸¤ä¸ªå–æ¶ˆæŒ‰é’®å¾ˆå†—ä½™ï¼Œä½†è‡³å°‘å¯¹ç§°ä¸æ˜¯åš’ï¼Ÿ(^â–½^)o

1)  **å¯¹é¢„è§ˆçš„æ‰§å¿µ**ï¼š
    -   ä¹‹å‰åœ¨ç”¨arcmapå‡ºå›¾çš„æ—¶å€™ï¼Œå¯¹è¿™ä¸ªæ·±æ¶ç—›ç»ã€‚æˆ‘æ¯æ¬¡éƒ½è¦æ‰“å°å‡ºæ¥æ‰çŸ¥é“é•¿ä»€ä¹ˆæ ·å°±å¾ˆåäººç±»ï¼Œä¸å–œæ¬¢è¿˜è¦åˆ æ‰ï¼Œä¸€æ¬¡å‡ºå›¾å¾—åˆ äº”å…­å¼ åºŸå›¾ã€‚

    -   è€å¸ˆå±•ç¤ºçš„çª—ä½“é‡Œæœ‰ä¸€ä¸ªæ‰“å°é¢„è§ˆï¼Œè¿™ä¸ªä¼¼ä¹æ˜¯è¦å¼¹å‡ºä¸€ä¸ªå¤§çª—ä½“çš„ï¼Œä½†æˆ‘è§‰å¾—ä¸å®æ—¶ï¼Œä¸åƒæˆ‘è¿™ä¸ªå˜¿å˜¿å˜¿ï¼ŒçœŸçš„å¾ˆæ»¡æ„è¿™ä¸ªå®æ—¶é¢„è§ˆï¼Œåˆ‡æ¢çš„æ—¶å€™ä¹Ÿä¸ä¼šè§¦å‘è¿‡äºæ˜æ˜¾çš„åˆ·æ–°é—ªçƒï¼Œå¾ˆå¹³æ»‘ï¼Œå¾ˆæµç•…ï¼Œå¾ˆèˆ’æœã€‚
    -   ç”¨`Bitmap`åœ¨å†…å­˜é‡Œå»ºä¸€å¼ çº¸ï¼Œç„¶ååˆ©ç”¨`IActiveView.Output`æ–¹æ³•æŠŠå½“å‰å¸ƒå±€è§†å›¾â€œç”»â€åˆ°è¿™ä¸ª`Bitmap`çš„`HDC`ï¼ˆè®¾å¤‡ä¸Šä¸‹æ–‡ï¼‰ä¸Šï¼Œæœ€åæŠŠå›¾èµ‹ç»™`PictureBox`ã€‚è¿™æ ·è°ƒæ•´æ¨ªçºµå‘ã€çº¸å¼ å¤§å°æ—¶ï¼Œé¢„è§ˆå›¾èƒ½é©¬ä¸Šå˜ï¼Œä½“éªŒæ‹‰æ»¡ï¼Œå¤ªæµç•…äº†ï¼›

    -   ä½†æˆ‘å¼€å§‹å¾ˆå¤©çœŸï¼Œæˆ‘å¼€å§‹æƒ³ç”¨`axPageLayoutControl`æ§ä»¶ï¼Œç„¶åå†™ä¸ªåŒæ­¥ç›´æ¥æŠŠä¸»çª—ä½“çš„`Layout`ç»™`copy`è¿‡æ¥ï¼Œä½†å¾ˆä¸å¹¸ï¼Œè¿™ç©æ„å’Œæˆ‘è®¾ç½®çš„çº¸å¼ å¤§å°æ¯”ä¾‹å®Œå…¨ä¸ä¸€æ ·ï¼›

    -   ç„¶åæ¢äº†`PictureBox`ï¼Œæƒ³ç€ç›´æ¥æŠŠå®ƒé‡ç»˜ï¼Œå¾ˆæ˜æ˜¾ï¼Œå¤±è´¥äº†ï¼Œé—ªçš„æˆ‘çœ¼ç›éƒ½å¿«çäº†ğŸ˜­ï¼Œè€Œä¸”`PictureBox`è®¾ä¸äº†åŒç¼“å†²å•Šï¼ŒFormè®¾ç½®åŒç¼“å†²åªæ˜¯é—ªçš„ä¸é‚£ä¹ˆæ˜æ˜¾äº†...

    -   ç„¶åé—®äº†`Gemini`ï¼Œå…ˆç”¨`Bitmap`æŠŠå›¾ç”»åœ¨å†…å­˜é‡Œï¼Œå†æ”¾å‡ºæ¥ï¼Œå…¶å®å°±è¾¾åˆ°äº†åŒç¼“å†²çš„ç›®çš„äº†ï¼ˆ`è®¡ç®—æœºå›¾å½¢å­¦ç«‹å¤§åŠŸ`ï¼‰ã€‚

    -   ä¸ºä»€ä¹ˆè¦è¿™ä¸ª`HDC`ã€‚å…¶å®å°±è·Ÿ`è®¡ç®—æœºå›¾å½¢å­¦`çš„`glfwMakeContextCurrent(window);`ä¸€æ ·ï¼Œå¿…é¡»æœ‰ä¸ªä¸­é—´äººæ¥ä¼ æ•°æ®ï¼Œä¸ç„¶åŒæ–¹éƒ½çœ‹ä¸æ‡‚ä¿¡æ¯ã€‚ï¼ˆåˆ»åœ¨éª¨å­é‡Œçš„`è®¡ç®—æœºå›¾å½¢å­¦`...ä½†ç¡®å®å¥½åƒï¼‰

        >   å…¶å®æˆ‘æ„Ÿè§‰è€å¸ˆçš„æ–‡æ¡£è¦æ±‚ç»™é”™äº†ï¼Œä¸ºä»€ä¹ˆæ˜¯`MapControl`ï¼Œåº”è¯¥æ˜¯`PageLayout`å§ï¼Ÿä¹‹å‰ä¸å†™è¿‡ä¸€ä¸ªå¯¼å‡º`MapControl`é‡Œçš„åŠŸèƒ½åš’ã€‚

2)  **å¯¼å‡ºè·¯å¾„**ï¼š
    -   æœ€å¼€å§‹æœ‰ä¸ª`BUG`ï¼šç‚¹`æµè§ˆ`Buttoné€‰å¥½è·¯å¾„åï¼Œç‚¹`å¯¼å‡º\æ‰“å°`Buttonåˆå¼¹äº†ä¸€æ¬¡ä¿å­˜æ¡†ï¼Œå¯¼è‡´ä¹‹å‰æµè§ˆé€‰çš„è·¯å¾„æ ¹æœ¬æ²¡ç”¨äº†ã€‚ä¿®å¤åï¼Œç‚¹å‡»`å¯¼å‡º`Buttonæ—¶ä¼šç›´æ¥è¯»å–æ–‡æœ¬æ¡†é‡Œçš„è·¯å¾„ï¼Œåªæœ‰å½“è·¯å¾„ä¸ºç©ºæ—¶æ‰æé†’ï¼›

    -   ç„¶åæµè§ˆæŒ‰é’®ç”¨çš„æ˜¯`FolderBrowserDialog`ï¼Œåªèƒ½é€‰æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶åè¿˜å¾—å›ä¸»ç•Œé¢æ‰‹æ•²ï¼Œç´¯ç´¯çš„ã€‚åæ¥æ”¹æˆäº†`SaveFileDialog`ï¼Œè¿™æ ·åœ¨æµè§ˆæ—¶å°±èƒ½ç›´æ¥å®šå¥½æ–‡ä»¶åï¼Œä¸èµ–ï¼›
    

3)  **PDFä¸å›¾ç‰‡å¯¼å‡º**ï¼šä»£ç é‡Œçš„`æ‰“å°`Buttonç›®çš„æ˜¯å¯¼å‡ºPDFï¼ˆ`ExportPDFClass`ï¼‰ï¼šå›¾ç‰‡å¯¼å‡ºä½¿ç”¨äº†`ExportJPEGClass`å’Œ`ExportPNGClass`ã€‚è¿™æœ‰ä¸ªå…³é”®ç‚¹ï¼šå¿…é¡»æ ¹æ®é€‰å®šçš„çº¸å¼ å°ºå¯¸ï¼ˆè‹±å¯¸ï¼‰ä¹˜ä»¥DPIæ¥è®¡ç®—`PixelBounds`ï¼Œå¹¶è¯»å–`activeView.ExportFrame`ï¼Œè¿™æ ·å¯¼å‡ºæ¥çš„å°ºå¯¸æ‰æ˜¯å¯¹çš„ï¼Œä¸”ä¸ä¼šæœ‰å·¨å¤§ç•™ç™½ï¼›

4)  **å¯¼å…¥PageLayout**ï¼š`FormPrint`çª—ä½“ä¸èƒ½å‡­ç©ºå¯¼å‡ºï¼Œå®ƒå¾—çŸ¥é“ä¸»çª—ä½“é‡Œç”»äº†å•¥ã€‚æ‰€ä»¥åœ¨æ„é€ å‡½æ•°é‡ŒåŠ äº†ä¸ªå‚æ•°`public FormPrint(AxPageLayoutControl mainPageLayoutControl)`ï¼ŒæŠŠä¸»çª—ä½“çš„å¸ƒå±€æ§ä»¶ä¼ è¿›æ¥,è¿™ä¹Ÿåœ¨æ‰“å°çª—ä½“é‡Œæ“ä½œçš„`ActiveView`ï¼Œå°±æ˜¯ä¸»çª—ä½“é‡Œçš„`PageLayout`ï¼›

5)  **èµ„æºæ¸…ç†**ï¼šå¯¼å‡ºå¯¹è±¡`IExport`ç”¨å®Œè°ƒç”¨`Cleanup()`ï¼›é¢„è§ˆç”¨çš„`Bitmap`ç”¨å®Œè°ƒç”¨`Dispose()`ï¼Œä¸ç„¶ç‚¹å‡ æ¬¡é¢„è§ˆå†…å­˜å°±çˆ†äº†ï¼Œä¿è¯ä¸å´©æºƒã€‚


## æ ¸å¿ƒä»£ç 

### å®æ—¶é¢„è§ˆç”Ÿæˆ(Bitmapä¼ªåŒç¼“å†²)
``` C#
/// <summary>
/// æ›´æ–°æ‰“å°é¢„è§ˆ
/// </summary>
private void UpdatePreview()
{
    if (_mainPageLayoutControl == null || _mainPageLayoutControl.ActiveView == null)
    {
        picPreview.Image = null;
        return;
    }

    try
    {
        // æ¸…ç†æ—§çš„é¢„è§ˆå›¾ç‰‡
        if (_previewBitmap != null)
        {
            picPreview.Image = null;
            _previewBitmap.Dispose();
            _previewBitmap = null;
        }

        // è·å–çº¸å¼ å°ºå¯¸
        double widthInches, heightInches;
        GetPaperSizeInInches(out widthInches, out heightInches);

        // ä½¿ç”¨è¾ƒä½çš„é¢„è§ˆåˆ†è¾¨ç‡ä»¥æé«˜æ€§èƒ½
        int previewDpi = 96;
        int previewWidth = (int)(widthInches * previewDpi);
        int previewHeight = (int)(heightInches * previewDpi);

        // åˆ›å»ºé¢„è§ˆä½å›¾
        _previewBitmap = new Bitmap(previewWidth, previewHeight);

        using (Graphics g = Graphics.FromImage(_previewBitmap))
        {
            g.Clear(Color.White);

            // è·å– HDC
            IntPtr hdc = g.GetHdc();

            try
            {
                // è®¾ç½®è¾“å‡ºçŸ©å½¢
                tagRECT outputRect;
                outputRect.left = 0;
                outputRect.top = 0;
                outputRect.right = previewWidth;
                outputRect.bottom = previewHeight;

                // è¾“å‡ºåˆ° HDC
                IActiveView activeView = _mainPageLayoutControl.ActiveView;
                activeView.Output(hdc.ToInt32(), previewDpi, ref outputRect, null, null);
            }
            finally
            {
                g.ReleaseHdc(hdc);
            }
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        picPreview.Image = _previewBitmap;
    }
    catch (Exception ex)
    {
        // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (_previewBitmap != null)
        {
            _previewBitmap.Dispose();
            _previewBitmap = null;
        }

        _previewBitmap = new Bitmap(400, 300);
        using (Graphics g = Graphics.FromImage(_previewBitmap))
        {
            g.Clear(Color.White);
            g.DrawString("é¢„è§ˆç”Ÿæˆå¤±è´¥:\n" + ex.Message,
                new Font("Microsoft YaHei", 10),
                Brushes.Red,
                new RectangleF(10, 10, 380, 280));
        }
        picPreview.Image = _previewBitmap;
    }
}

```

### PDFå¯¼å‡º
``` C#
/// <summary>
/// å¯¼å‡ºä¸ºPDF
/// </summary>
private void ExportToPDF(string outputPath)
{
    // å§‹ç»ˆä½¿ç”¨ä¸»çª—ä½“çš„ PageLayoutControl è¿›è¡Œå¯¼å‡ºï¼Œé¿å… COM å¯¹è±¡å¤åˆ¶é—®é¢˜
    if (_mainPageLayoutControl == null || _mainPageLayoutControl.ActiveView == null)
    {
        throw new Exception("æ— æ³•è·å–æ´»åŠ¨è§†å›¾");
    }

    IActiveView activeView = _mainPageLayoutControl.ActiveView;
    IExport pExport = null;

    try
    {
        // åˆ›å»ºPDFå¯¼å‡ºå¯¹è±¡
        pExport = new ExportPDFClass();
        pExport.ExportFileName = outputPath;

        // è®¾ç½®åˆ†è¾¨ç‡
        int dpi = 300;
        pExport.Resolution = dpi;

        // è·å–å¯¼å‡ºèŒƒå›´ - ä½¿ç”¨ PageLayout çš„å®é™…èŒƒå›´
        tagRECT exportRect = activeView.ExportFrame;

        // æ ¹æ®çº¸å¼ å¤§å°è®¾ç½®å°ºå¯¸ï¼ˆåƒç´ ï¼‰
        int width = (int)(8.27 * dpi);   // A4 é»˜è®¤å®½åº¦
        int height = (int)(11.69 * dpi); // A4 é»˜è®¤é«˜åº¦

        if (cmbPaperSize.SelectedItem != null)
        {
            switch (cmbPaperSize.SelectedItem.ToString())
            {
                case "A3":
                    width = (int)(11.69 * dpi);
                    height = (int)(16.54 * dpi);
                    break;
                case "A2":
                    width = (int)(16.54 * dpi);
                    height = (int)(23.39 * dpi);
                    break;
                case "Letter":
                    width = (int)(8.5 * dpi);
                    height = (int)(11 * dpi);
                    break;
            }
        }

        // æ ¹æ®çº¸å¼ æ–¹å‘è°ƒæ•´
        if (radioButton1.Checked) // æ¨ªå‘
        {
            int temp = width;
            width = height;
            height = temp;
        }

        exportRect.left = 0;
        exportRect.top = 0;
        exportRect.right = width;
        exportRect.bottom = height;

        // è®¾ç½®å¯¼å‡ºåƒç´ èŒƒå›´
        IEnvelope pEnvelope = new EnvelopeClass();
        pEnvelope.PutCoords(exportRect.left, exportRect.top, exportRect.right, exportRect.bottom);
        pExport.PixelBounds = pEnvelope;

        // å¼€å§‹å¯¼å‡º
        int hDC = pExport.StartExporting();
        activeView.Output(hDC, dpi, ref exportRect, null, null);
        pExport.FinishExporting();
    }
    finally
    {
        // ç¡®ä¿æ¸…ç†èµ„æº
        if (pExport != null)
        {
            pExport.Cleanup();
        }
    }
}
```

### å›¾ç‰‡å¯¼å‡º
``` C#
/// <summary>
/// å¯¼å‡ºä¸ºå›¾ç‰‡
/// </summary>
private void ExportToImage(string outputPath, bool isPng, int dpi)
{
    // å§‹ç»ˆä½¿ç”¨ä¸»çª—ä½“çš„ PageLayoutControl è¿›è¡Œå¯¼å‡ºï¼Œé¿å… COM å¯¹è±¡å¤åˆ¶é—®é¢˜
    if (_mainPageLayoutControl == null || _mainPageLayoutControl.ActiveView == null)
    {
        throw new Exception("æ— æ³•è·å–æ´»åŠ¨è§†å›¾");
    }

    IActiveView activeView = _mainPageLayoutControl.ActiveView;
    IExport pExport = null;

    try
    {
        // åˆ›å»ºå¯¼å‡ºå¯¹è±¡
        if (isPng)
        {
            pExport = new ExportPNGClass();
        }
        else
        {
            pExport = new ExportJPEGClass();
        }

        pExport.ExportFileName = outputPath;
        pExport.Resolution = dpi;

        // è·å–å¯¼å‡ºèŒƒå›´ - ä½¿ç”¨ PageLayout çš„å®é™…èŒƒå›´
        tagRECT exportRect = activeView.ExportFrame;

        // è®¡ç®—å¯¼å‡ºå°ºå¯¸ï¼ˆæ ¹æ®åˆ†è¾¨ç‡ç¼©æ”¾ï¼‰
        double scale = dpi / 96.0;
        int width = (int)(exportRect.right * scale);
        int height = (int)(exportRect.bottom * scale);

        exportRect.left = 0;
        exportRect.top = 0;
        exportRect.right = width;
        exportRect.bottom = height;

        // è®¾ç½®å¯¼å‡ºåƒç´ èŒƒå›´
        IEnvelope pEnvelope = new EnvelopeClass();
        pEnvelope.PutCoords(exportRect.left, exportRect.top, exportRect.right, exportRect.bottom);
        pExport.PixelBounds = pEnvelope;

        // å¼€å§‹å¯¼å‡º
        int hDC = pExport.StartExporting();
        activeView.Output(hDC, dpi, ref exportRect, null, null);
        pExport.FinishExporting();
    }
    finally
    {
        // ç¡®ä¿æ¸…ç†èµ„æº
        if (pExport != null)
        {
            pExport.Cleanup();
        }
    }
}

```
### æ‰“å°è·¯å¾„äº¤äº’ï¼ˆSaveFileDialogï¼‰
``` C#
/// <summary>
/// æµè§ˆPDFä¿å­˜è·¯å¾„ (æ”¹ä¸º SaveFileDialog)
/// </summary>
private void BtnExPath1_Click(object sender, EventArgs e)
{
    using (SaveFileDialog dialog = new SaveFileDialog())
    {
        dialog.Title = "é€‰æ‹©PDFä¿å­˜è·¯å¾„";
        dialog.Filter = "PDFæ–‡ä»¶(*.pdf)|*.pdf";
        dialog.OverwritePrompt = false; //å› ä¸ºçœŸæ­£ä¿å­˜æ˜¯åœ¨ç‚¹"æ‰“å°"æ—¶ï¼Œè¿™é‡Œè®¾ä¸ºfalseé¿å…é‡å¤å¼¹çª—ï¼Œæˆ–è€…è®¾ä¸ºtrueä½œä¸ºé¢„è­¦ä¹Ÿå¯ä»¥

        // å°è¯•è·å–å½“å‰æ–‡æœ¬æ¡†çš„è·¯å¾„ä½œä¸ºåˆå§‹ç›®å½•
        string currentPath = txtExPath1.Text.Trim();
        if (!string.IsNullOrEmpty(currentPath))
        {
            try
            {
                string dir = System.IO.Path.GetDirectoryName(currentPath);
                string fileName = System.IO.Path.GetFileName(currentPath);

                if (System.IO.Directory.Exists(dir))
                {
                    dialog.InitialDirectory = dir;
                }
                dialog.FileName = fileName;
            }
            catch { } // å¿½ç•¥è·¯å¾„è§£æé”™è¯¯
        }
        else
        {
            // å¦‚æœæ–‡æœ¬æ¡†ä¸ºç©ºï¼Œç»™ä¸ªé»˜è®¤å
            dialog.FileName = "åœ°å›¾å¯¼å‡º_" + DateTime.Now.ToString("yyMMdd") + ".pdf";
        }

        if (dialog.ShowDialog() == DialogResult.OK)
        {
            txtExPath1.Text = dialog.FileName;
        }
    }
}

```

### å¯¼å‡ºè·¯å¾„äº¤äº’ï¼ˆSaveFileDialogï¼‰
``` C#
/// <summary>
/// æµè§ˆå›¾ç‰‡ä¿å­˜è·¯å¾„ (æ”¹ä¸º SaveFileDialog)
/// </summary>
private void BtnExPath2_Click(object sender, EventArgs e)
{
    using (SaveFileDialog dialog = new SaveFileDialog())
    {
        dialog.Title = "é€‰æ‹©å›¾ç‰‡ä¿å­˜è·¯å¾„";

        // 1. åˆ¤æ–­å½“å‰é€‰ä¸­çš„æ ¼å¼
        bool isPng = false;
        if (cmbExportFormat.SelectedItem != null && cmbExportFormat.SelectedItem.ToString().Contains("PNG"))
        {
            isPng = true;
        }

        // 2. åŠ¨æ€è®¾ç½®è¿‡æ»¤å™¨
        if (isPng)
        {
            dialog.Filter = "PNGå›¾ç‰‡(*.png)|*.png";
            dialog.DefaultExt = "png";
        }
        else
        {
            dialog.Filter = "JPEGå›¾ç‰‡(*.jpg)|*.jpg";
            dialog.DefaultExt = "jpg";
        }

        // 3. å°è¯•è·å–å½“å‰æ–‡æœ¬æ¡†çš„è·¯å¾„ä½œä¸ºåˆå§‹ç›®å½•
        string currentPath = txtExPath2.Text.Trim();
        if (!string.IsNullOrEmpty(currentPath))
        {
            try
            {
                string dir = System.IO.Path.GetDirectoryName(currentPath);
                string fileName = System.IO.Path.GetFileName(currentPath);

                // å¦‚æœå½“å‰æ–‡æœ¬æ¡†é‡Œçš„åç¼€å’Œé€‰ä¸­çš„æ ¼å¼ä¸ç¬¦ï¼Œè‡ªåŠ¨ä¿®æ­£æ–‡ä»¶ååç¼€
                string expectedExt = isPng ? ".png" : ".jpg";
                if (!fileName.ToLower().EndsWith(expectedExt))
                {
                    fileName = System.IO.Path.GetFileNameWithoutExtension(fileName) + expectedExt;
                }

                if (System.IO.Directory.Exists(dir))
                {
                    dialog.InitialDirectory = dir;
                }
                dialog.FileName = fileName;
            }
            catch { }
        }
        else
        {
            string ext = isPng ? ".png" : ".jpg";
            dialog.FileName = "åœ°å›¾å¯¼å‡º_" + DateTime.Now.ToString("yyMMdd") + ext;
        }

        if (dialog.ShowDialog() == DialogResult.OK)
        {
            txtExPath2.Text = dialog.FileName;
        }
    }
}
```

### ç›´æ¥æ‰§è¡Œæ‰“å°ï¼ˆå»é™¤å†—ä½™å¼¹çª—ï¼‰
``` C#
private void BtnPrint_Click(object sender, EventArgs e)
{
    ...
    // 1. ç›´æ¥è·å–æ–‡æœ¬æ¡†è·¯å¾„
    string outputPath = txtExPath1.Text.Trim();

    // 2. æ ¡éªŒè·¯å¾„æ˜¯å¦ä¸ºç©º
    if (string.IsNullOrEmpty(outputPath))
    {
        MessageBox.Show("è¯·å…ˆè®¾ç½®ä¿å­˜è·¯å¾„ï¼", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        return;
    }

    try
    {
        // 3. ç›´æ¥è°ƒç”¨å¯¼å‡ºæ–¹æ³•ï¼Œä¸å†å¼¹å‡º SaveFileDialog
        ExportToPDF(outputPath);
        MessageBox.Show("PDFå¯¼å‡ºæˆåŠŸï¼\nä¿å­˜è·¯å¾„: " + outputPath, "æˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
    }
    catch (Exception ex)
    {
        MessageBox.Show("æ‰“å°å¤±è´¥: " + ex.Message, "é”™è¯¯", MessageBoxButtons.OK, MessageBoxIcon.Error);
    }
}
```

### ç›´æ¥æ‰§è¡Œå¯¼å‡ºï¼ˆå»é™¤å†—ä½™å¼¹çª—ï¼‰
``` C#
/// <summary>
/// å¯¼å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
/// </summary>
private void BtnExport_Click(object sender, EventArgs e)
{
    if (cmbExportFormat.SelectedItem == null)
    {
        MessageBox.Show("è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        return;
    }

    // 1. è·å–æ–‡æœ¬æ¡†è·¯å¾„
    string outputPath = txtExPath2.Text.Trim();

    // 2. æ ¡éªŒè·¯å¾„
    if (string.IsNullOrEmpty(outputPath))
    {
        MessageBox.Show("è¯·å…ˆè®¾ç½®ä¿å­˜è·¯å¾„ï¼", "æç¤º", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        return;
    }

    try
    {
        string format = cmbExportFormat.SelectedItem.ToString();

        // ç¡®ä¿æ‰©å±•åæ­£ç¡®ï¼ˆé˜²æ­¢ç”¨æˆ·æ‰‹åŠ¨æ”¹äº†æ–‡æœ¬æ¡†ä½†æ²¡æ”¹åç¼€ï¼‰
        // å¦‚æœæ–‡æœ¬æ¡†é‡Œæ˜¯ .jpg ä½†é€‰çš„æ˜¯ PNGæ ¼å¼ï¼Œè¿™é‡Œå¯ä»¥åšä¸ªå¼ºåˆ¶ä¿®æ­£ï¼Œæˆ–è€…ä¿¡ä»»ç”¨æˆ·
        // è¿™é‡Œä¿æŒç®€å•ï¼Œç›´æ¥ç”¨æ–‡æœ¬æ¡†çš„è·¯å¾„

        // è·å–åˆ†è¾¨ç‡
        int dpi = 300;
        if (cmbDPI.SelectedItem != null)
        {
            int.TryParse(cmbDPI.SelectedItem.ToString(), out dpi);
        }

        // 3. ç›´æ¥å¯¼å‡ºï¼Œä¸å†å¼¹å‡º SaveFileDialog
        ExportToImage(outputPath, format.Contains("PNG"), dpi);

        MessageBox.Show("å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼\nä¿å­˜è·¯å¾„: " + outputPath, "æˆåŠŸ", MessageBoxButtons.OK, MessageBoxIcon.Information);
    }
    catch (Exception ex)
    {
        MessageBox.Show("å¯¼å‡ºå¤±è´¥: " + ex.Message, "é”™è¯¯", MessageBoxButtons.OK, MessageBoxIcon.Error);
    }
}

```


## åŠŸèƒ½å®ç°æˆªå›¾
>   **æ‰“å°å¯¼å‡ºä¸»ç•Œé¢ï¼ˆé¢„è§ˆA4æ¨ªå‘ï¼‰**![PrintPreview1](Image/PrintAndOutPut_Image/A4_Landscape.png)

>   **æ‰“å°å¯¼å‡ºä¸»ç•Œé¢ï¼ˆé¢„è§ˆA4çºµå‘ï¼‰**![PrintPreview1](Image/PrintAndOutPut_Image/A4_Portrait.png)

>   **æ‰“å°æœº**![PrintPreview1](Image/PrintAndOutPut_Image/cmbPrinter.png)

>   **çº¸å¼ å¤§å°**![PrintPreview1](Image/PrintAndOutPut_Image/cmbPaperSize.png)

>   **å›¾ç‰‡æ ¼å¼**![PrintPreview1](Image/PrintAndOutPut_Image/cmbExportFormat.png)

>   **å›¾ç‰‡DPI**![PrintPreview1](Image/PrintAndOutPut_Image/cmdDPI.png)

>   **PDFå¯¼å‡º**![PrintPreview1](Image/PrintAndOutPut_Image/PDF1.png)

>   **PDFå¯¼å‡º**![PrintPreview1](Image/PrintAndOutPut_Image/PDF2.png)

### **ğŸ“„ç‚¹å‡»æŸ¥çœ‹PDF** [åœ°å›¾å¯¼å‡º_230105](Image/PrintAndOutPut_Image/åœ°å›¾å¯¼å‡º_260105.pdf)

>   **JPGå¯¼å‡º**![PrintPreview1](Image/PrintAndOutPut_Image/JPG1.png)

>   **JPGå¯¼å‡º**![PrintPreview1](Image/PrintAndOutPut_Image/JPG2.png)

>   **JPGå¯¼å‡ºå®ä¾‹**![PrintPreview1](Image/PrintAndOutPut_Image/åœ°å›¾å¯¼å‡º_260105.jpg)

### [â–¶ç‚¹å‡»è§‚çœ‹æ¼”ç¤ºè§†é¢‘](Video/Print_Demo.mp4)

>   **JPGåˆ¶å›¾å®ä¾‹**![PrintPreview1](Image/Map_Image/é’å²›å¸‚è¡Œæ”¿åŒºåˆ’å›¾.jpg)

>   **ğŸ“„ç‚¹å‡»æŸ¥çœ‹PDF** [é’å²›å¸‚è¡Œæ”¿åŒºåˆ’å›¾](Image/Map_Image/é’å²›å¸‚è¡Œæ”¿åŒºåˆ’å›¾.pdf)



#   äº”ã€æ”¶è·ä¸å±•æœ›
>   å§‹`2025.2.25`

>   ç»è¿‡ä¸€å¹´çš„`C#`æœ‰å…³è¯¾ç¨‹çš„å­¦ä¹ ï¼Œä»ä¸Šå­¦æœŸæœ€å¼€å§‹çš„å‘½ä»¤è¡Œ`Console`è¾“å‡ºå†åˆ°å†™å‡ºç¬¬ä¸€ä¸ª`å±å¹•ä¸Šä¸æ–­ç§»åŠ¨çš„é¢œæ–‡å­—ã€å°æ–¹å—`ï¼Œå†åˆ°ä¸Šå­¦æœŸæœŸæœ«å†™çš„`åå®¹é“`ã€`ç®€æ˜“CAD`ã€`Spiderè¡¨ç›˜`ï¼Œæ¥ç€åˆ°è¿™å­¦æœŸå®ç°çš„`ç®€æ˜“GISè½¯ä»¶`ï¼Œè‡ªå·±å†™äº†å¾ˆå¤šå°é¡¹ç›®ï¼Œè¿™äº›éƒ½å¾ˆæœ‰æ„æ€ï¼Œä¹Ÿè®©æˆ‘å¯¹ç¼–ç¨‹æœ‰äº†å¾ˆå¼ºçš„å…´è¶£ã€‚

>   åœ¨å¤§äºŒä¸Šå­¦Cè¯­è¨€çš„æ—¶å€™ï¼Œè§‰å¾—è¿™ä¸œè¥¿å¤ªæ¯ç‡¥äº†ï¼Œä¸€å­¦æœŸæ„Ÿè§‰éƒ½åœ¨å’Œæ•°å­¦é€»è¾‘æ‰“äº¤é“ï¼Œä¼¼ä¹éƒ½è½ä¸åˆ°ç°å®ä¸Šï¼Œçœ‹ä¸è§å®çš„ä¸œè¥¿ã€‚ä½†å¤§äºŒä¸‹æ¥è§¦äº†`C#`å’Œ`Webç«¯å¼€å‘`ï¼Œæˆ‘æ‰å‘ç°åŸæ¥æˆ‘å¯ä»¥å®ç°è¿™ä¹ˆå¤šä¸œè¥¿ï¼Œåšä¸€ä¸ªå°ç½‘é¡µï¼Œåšä¸€ä¸ªå°æ¸¸æˆç­‰ç­‰ã€‚

>   åœ¨è¿™ç§å…´è¶£é€æ¸æµ“åšçš„è¿‡ç¨‹ä¸­ä¹Ÿæ…¢æ…¢åœ°èƒ½å¤Ÿè®©è‡ªå·±æ²‰ä¸‹å¿ƒæ¥çœŸæ­£å»ç ”ç©¶åº•å±‚çš„ä¸œè¥¿ï¼Œä»æœ€åˆåœ¨`devc++`ä¸Šè¿ä¸ªå†’æ³¡æ’åºéƒ½ä¸æƒ³æ•²çš„æˆ‘ï¼Œæ…¢æ…¢æˆä¸ºäº†ä¸€ä¸ªæ„¿æ„ä»”ç»†å»çœ‹ä¸€ä¸ª`Bresenham`ç®—æ³•ï¼Œæ„¿æ„ä¸ºäº†è‡ªå·±æƒ³è¦å®ç°æŸä¸ªåŠŸèƒ½å»æŸ¥å„ç§èµ„æ–™ï¼Œæ„¿æ„é€è¡Œæ•²`OpenGL`çš„ä»£ç ï¼Œå­¦`Markdown`æ ¼å¼è®°å½•è‡ªå·±çš„æƒ³æ³•ä»¥åŠä»£ç çš„æˆ‘ï¼›
    >   ![PrintPreview1](Image/WhatIGet/CSharp.png)
    >   **ç”¨WinFormå¯è§†åŒ–çš„æ …æ ¼åŒ–ç®—æ³•**![PrintPreview1](Image/WhatIGet/DrawGraphics.png)
    >   **ç”¨WinFormä¸ºå¯åŠ¨çª—å£ï¼ŒImGUIä¸ºç»˜å›¾å±‚çš„PUBGçš„æµ‹è·å·¥å…·**![PrintPreview1](Image/WhatIGet/PUBGCalculation.png)

>   è¿™å­¦æœŸå†™çš„GISè½¯ä»¶æ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°çš„ï¼Œç¬¬ä¸€æ¬¡è‡ªå·±ä¸€æ­¥ä¸€æ­¥æ•²å‡ºæ¥è¿™ä¹ˆå¤šä»£ç ï¼Œåˆ›å»ºäº†è¿™ä¹ˆå¤šé¡¹ç›®æ–‡ä»¶ï¼Œè®©æˆ‘æ„è¯†åˆ°äº†åŸæ¥åŸºäºä¸€ä¸ªåˆä¸€ä¸ªçš„åŠŸèƒ½éœ€è¦è¿™ä¹ˆå¤§çš„ä»£ç é‡ï¼Œå®ç°ä¸€ä¸ªåŠŸèƒ½éœ€è¦å¥½å‡ ä¸ªå‡½æ•°ã€‚è¿™ä¸ä»…è®©æˆ‘å­¦ä¹ åˆ°äº†å¦‚ä½•åŸºäº`ArcEgine`è¿›è¡Œå¼€å‘ï¼Œä¹Ÿè®©æˆ‘å­¦åˆ°äº†è½¯ä»¶å¼€å‘èƒŒåçš„é€»è¾‘ï¼Œè®©æˆ‘è§è¯†åˆ°äº†å¼€å‘ä¸€ä¸ªè½¯ä»¶èƒŒåçš„å·¨å¤§å·¥ä½œé‡ã€‚

>   åœ¨å®Œå–„ä»£ç ï¼Œä¿®å¤`BUG`æ—¶ï¼Œæˆ‘å§‹ç»ˆåœ¨ç¢°å£ï¼Œä¿®å®Œä¸€ä¸ªBUGè€Œååˆå†’å‡ºä¸€ä¸ªBUGï¼Œå³ä½¿åˆ°ç°åœ¨ï¼Œä»ç„¶æœ‰äº›å°ä¸è¶³ï¼Œå¦‚:é¹°çœ¼æ— æ³•åŒæ­¥`PageLayOut`ï¼Œç¢äºæ—¶é—´é™åˆ¶ï¼Œæˆ‘æ— æ³•è¿›ä¸€æ­¥ä¿®æ”¹ï¼Œä½†æˆ‘ä¼šå¥”ç€æ›´å¥½çš„æ–¹å‘åŠªåŠ›çš„ã€‚

>   ä¸çŸ¥é“é©¬è€å¸ˆæ˜¯å¦ä¼šçœ‹åˆ°è¿™é‡Œï¼Œä½†æ˜¯æˆ‘å§‹ç»ˆå¾ˆæ„Ÿè°¢é©¬è€å¸ˆåœ¨å­¦ä¹ è·¯ä¸Šå¯¹æˆ‘çš„æŒ‡å¼•ã€‚é©¬è€å¸ˆçš„è®²è¯¾é£æ ¼ä¹Ÿå¾ˆè½»æ¾ï¼Œæˆ‘ä¸€ç›´å¾ˆå–œæ¬¢è½»æ¾çš„è¯¾å ‚æ°›å›´ï¼Œé©¬è€å¸ˆä¼šåœ¨è¯¾ä¸Šæé†’æˆ‘ä»¬å˜å¤©å¤šç©¿è¡£æœï¼Œç”²æµæ³¨æ„æˆ´å£ç½©ï¼Œä¹Ÿä¼šåœ¨ä¸‹åˆä¸‰ç‚¹çš„è¯¾ä¸Šè®²ä¸€äº›è¶£äº‹è®©æˆ‘ä»¬æ‰“èµ·ç²¾ç¥ã€‚å¾ˆå¹¸è¿æˆ‘å¯ä»¥é‡åˆ°æ‚¨è¿™æ ·è®¤çœŸè´Ÿè´£çš„è€å¸ˆå¸¦æˆ‘C#å…¥é—¨ï¼Œéå¸¸æ„Ÿè°¢é©¬è€å¸ˆå¯¹æˆ‘åœ¨ç¼–ç¨‹è·¯ä¸Šçš„æŒ‡å¼•ã€‚

>   æœ€åï¼Œç¥æ‚¨èº«ä½“å¥åº·ã€ä¸‡äº‹å¦‚æ„ã€æ¡ƒææ»¡å¤©ä¸‹ï¼

>   å†™äº`2026.1.6`